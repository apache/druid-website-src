<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-development/extensions-contrib/k8s-jobs" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">MM-less Druid in K8s | Apache® Druid</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://druid.apache.org/img/druid_nav.png"><meta data-rh="true" name="twitter:image" content="https://druid.apache.org/img/druid_nav.png"><meta data-rh="true" property="og:url" content="https://druid.apache.org/docs/30.0.0/development/extensions-contrib/k8s-jobs"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="MM-less Druid in K8s | Apache® Druid"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://druid.apache.org/docs/30.0.0/development/extensions-contrib/k8s-jobs"><link data-rh="true" rel="alternate" href="https://druid.apache.org/docs/30.0.0/development/extensions-contrib/k8s-jobs" hreflang="en"><link data-rh="true" rel="alternate" href="https://druid.apache.org/docs/30.0.0/development/extensions-contrib/k8s-jobs" hreflang="x-default"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-131010415-1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-131010415-1",{})</script>





<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js"></script><link rel="stylesheet" href="/assets/css/styles.60a7f877.css">
<link rel="preload" href="/assets/js/runtime~main.042a693d.js" as="script">
<link rel="preload" href="/assets/js/main.159ed78c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top navbar--dark"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/druid_nav.png" alt="Apache® Druid" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/druid_nav.png" alt="Apache® Druid" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/technology">Technology</a><a class="navbar__item navbar__link" href="/use-cases">Use Cases</a><a class="navbar__item navbar__link" href="/druid-powered">Powered By</a><a class="navbar__item navbar__link" href="/docs/30.0.0/design/">Docs</a><a class="navbar__item navbar__link" href="/community/">Community</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Apache®</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://apachecon.com/?ref=druid.apache.org" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a class="navbar__item navbar__link" href="/downloads/">Download</a><div class="searchBox_ZlJk"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>MM-less Druid in K8s</h1></header><p>Apache Druid Extension to enable using Kubernetes for launching and managing tasks instead of the Middle Managers.  This extension allows you to launch tasks as kubernetes jobs removing the need for your middle manager.  </p><p>Consider this an <a href="/docs/30.0.0/development/experimental">EXPERIMENTAL</a> feature mostly because it has not been tested yet on a wide variety of long-running Druid clusters.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="how-it-works">How it works<a href="#how-it-works" class="hash-link" aria-label="Direct link to How it works" title="Direct link to How it works">​</a></h2><p>The K8s extension builds a pod spec for each task using the specified pod adapter. All jobs are natively restorable, they are decoupled from the Druid deployment, thus restarting pods or doing upgrades has no affect on tasks in flight.  They will continue to run and when the overlord comes back up it will start tracking them again.  </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a href="#configuration" class="hash-link" aria-label="Direct link to Configuration" title="Direct link to Configuration">​</a></h2><p>To use this extension please make sure to  <a href="/docs/30.0.0/configuration/extensions#loading-extensions">include</a><code>druid-kubernetes-overlord-extensions</code> in the extensions load list for your overlord process.</p><p>The extension uses <code>druid.indexer.runner.capacity</code> to limit the number of k8s jobs in flight. A good initial value for this would be the sum of the total task slots of all the middle managers you were running before switching to K8s based ingestion. The K8s task runner uses one thread per Job that is created, so setting this number too large can cause memory issues on the overlord. Additionally set the variable <code>druid.indexer.runner.namespace</code> to the namespace in which you are running druid.</p><p>Other configurations required are:
<code>druid.indexer.runner.type: k8s</code> and <code>druid.indexer.task.encapsulatedTask: true</code></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="pod-adapters">Pod Adapters<a href="#pod-adapters" class="hash-link" aria-label="Direct link to Pod Adapters" title="Direct link to Pod Adapters">​</a></h2><p>The logic defining how the pod template is built for your Kubernetes Job depends on which pod adapter you have specified.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="overlord-single-container-pod-adapteroverlord-multi-container-pod-adapter">Overlord Single Container Pod Adapter/Overlord Multi Container Pod Adapter<a href="#overlord-single-container-pod-adapteroverlord-multi-container-pod-adapter" class="hash-link" aria-label="Direct link to Overlord Single Container Pod Adapter/Overlord Multi Container Pod Adapter" title="Direct link to Overlord Single Container Pod Adapter/Overlord Multi Container Pod Adapter">​</a></h3><p>The overlord single container pod adapter takes the podSpec of your <code>Overlord</code> pod and creates a kubernetes job from this podSpec.  This is the default pod adapter implementation, to explicitly enable it you can specify the runtime property <code>druid.indexer.runner.k8s.adapter.type: overlordSingleContainer</code></p><p>The overlord multi container pod adapter takes the podSpec of your <code>Overlord</code> pod and creates a kubernetes job from this podSpec.  It uses kubexit to manage dependency ordering between the main container that runs your druid peon and other sidecars defined in the <code>Overlord</code> pod spec. Thus if you have sidecars such as Splunk or Istio it will be able to handle them. To enable this pod adapter you can specify the runtime property <code>druid.indexer.runner.k8s.adapter.type: overlordMultiContainer</code> </p><p>For the sidecar support to work for the multi container pod adapter, your entry point / command in docker must be explicitly defined your spec.</p><p>You can&#x27;t have something like this:
Dockerfile:
<code>ENTRYPOINT: [&quot;foo.sh&quot;]</code></p><p>and in your sidecar specs:</p><div class="language-container: codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-container: codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: foo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        args: </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           - arg1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           - arg2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That will not work, because we cannot decipher what your command is, the extension needs to know it explicitly.
*<em>Even for sidecars like Istio which are dynamically created by the service mesh, this needs to happen.</em></p><p>Instead do the following:
You can keep your Dockerfile the same but you must have a sidecar spec like so:</p><div class="language-container: codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-container: codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: foo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        command: foo.sh</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        args: </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           - arg1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           - arg2 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>For both of these adapters, you can add optional labels to your K8s jobs / pods if you need them by using the following configuration:
<code>druid.indexer.runner.labels: &#x27;{&quot;key&quot;:&quot;value&quot;}&#x27;</code>
Annotations are the same with:
<code>druid.indexer.runner.annotations: &#x27;{&quot;key&quot;:&quot;value&quot;}&#x27;</code></p><p>All other configurations you had for the middle manager tasks must be moved under the overlord with one caveat, you must specify javaOpts as an array:
<code>druid.indexer.runner.javaOptsArray</code>, <code>druid.indexer.runner.javaOpts</code> is no longer supported.</p><p>If you are running without a middle manager you need to also use <code>druid.processing.intermediaryData.storage.type=deepstore</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="custom-template-pod-adapter">Custom Template Pod Adapter<a href="#custom-template-pod-adapter" class="hash-link" aria-label="Direct link to Custom Template Pod Adapter" title="Direct link to Custom Template Pod Adapter">​</a></h3><p>The custom template pod adapter allows you to specify a pod template file per task type for more flexibility on how to define your pods. This adapter expects a <a href="https://kubernetes.io/docs/concepts/workloads/pods/#pod-templates" target="_blank" rel="noopener noreferrer">Pod Template</a> to be available on the overlord&#x27;s file system. This pod template is used as the base of the pod spec for the Kubernetes Job. You can override things like labels, environment variables, resources, annotation, or even the base image with this template. To enable this pod adapter you can specify the runtime property <code>druid.indexer.runner.k8s.adapter.type: customTemplateAdapter</code></p><p>The base pod template must be specified as the runtime property <code>druid.indexer.runner.k8s.podTemplate.base: /path/to/basePodSpec.yaml</code></p><p>Task specific pod templates can be specified as the runtime property <code>druid.indexer.runner.k8s.podTemplate.{taskType}: /path/to/taskSpecificPodSpec.yaml</code> where {taskType} is the name of the task type i.e <code>index_parallel</code>.</p><p>If you are trying to use the default image&#x27;s environment variable parsing feature to set runtime properties, you need to add a extra escape underscore when specifying pod templates.
e.g. set the environment variable <code>druid_indexer_runner_k8s_podTemplate_index__parallel</code> when setting <code>druid.indxer.runner.k8s.podTemplate.index_parallel</code></p><p>The following is an example Pod Template that uses the regular druid docker image.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: &quot;v1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: &quot;PodTemplate&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">template:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    annotations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      sidecar.istio.io/proxyCPU: &quot;512m&quot; # to handle a injected istio sidecar</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    labels:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      app.kubernetes.io/name: &quot;druid-realtime-backend&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  spec:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    affinity: {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    containers:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - command:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - sh</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - -c</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        - |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          /peon.sh /druid/data 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      env:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - name: CUSTOM_ENV_VARIABLE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        value: &quot;hello&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      image: apache/druid:30.0.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name: main</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      ports:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - containerPort: 8091</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: druid-tls-port</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        protocol: TCP</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - containerPort: 8100</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: druid-port</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        protocol: TCP</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      resources:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        limits:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          cpu: &quot;1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          memory: 2400M</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        requests:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          cpu: &quot;1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          memory: 2400M</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      volumeMounts:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - mountPath: /opt/druid/conf/druid/cluster/master/coordinator-overlord # runtime props are still mounted in this location because that&#x27;s where peon.sh looks for configs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: nodetype-config-volume</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        readOnly: true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - mountPath: /druid/data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: data-volume</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      - mountPath: /druid/deepstorage</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: deepstorage-volume</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    restartPolicy: &quot;Never&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    securityContext:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      fsGroup: 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      runAsGroup: 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      runAsUser: 1000</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tolerations:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - effect: NoExecute</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      key: node.kubernetes.io/not-ready</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      operator: Exists</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      tolerationSeconds: 300</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - effect: NoExecute</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      key: node.kubernetes.io/unreachable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      operator: Exists</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      tolerationSeconds: 300</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    volumes:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - configMap:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        defaultMode: 420</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        name: druid-tiny-cluster-peons-config</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name: nodetype-config-volume</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - emptyDir: {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name: data-volume</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    - emptyDir: {}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      name: deepstorage-volume</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The below runtime properties need to be passed to the Job&#x27;s peon process.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.port=8100 (what port the peon should run on)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.peon.mode=remote</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.service=druid/peon (for metrics reporting)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.indexer.task.baseTaskDir=/druid/data (this should match the argument to the ./peon.sh run command in the PodTemplate)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.indexer.runner.type=k8s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">druid.indexer.task.encapsulatedTask=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Any runtime property or JVM config used by the peon process can also be passed. E.G. below is a example of a ConfigMap that can be used to generate the <code>nodetype-config-volume</code> mount in the above template.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ConfigMap</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name: druid-tiny-cluster-peons-config</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    namespace: default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    jvm.config: |-</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -server</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -XX:MaxDirectMemorySize=1000M</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -Duser.timezone=UTC</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -Dfile.encoding=UTF-8</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -Dlog4j.debug</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -Djava.util.logging.manager=org.apache.logging.log4j.jul.LogManager</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -Djava.io.tmpdir=/druid/data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -Xmx1024M</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        -Xms1024M</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    log4j2.xml: |-</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;Configuration status=&quot;WARN&quot;&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;Appenders&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Console name=&quot;Console&quot; target=&quot;SYSTEM_OUT&quot;&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    &lt;PatternLayout pattern=&quot;%d{ISO8601} %p [%t] %c - %m%n&quot;/&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;/Console&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;/Appenders&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;Loggers&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;Root level=&quot;info&quot;&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                    &lt;AppenderRef ref=&quot;Console&quot;/&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                &lt;/Root&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            &lt;/Loggers&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        &lt;/Configuration&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    runtime.properties: |</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        druid.port=8100</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        druid.service=druid/peon</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        druid.server.http.numThreads=5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        druid.indexer.task.baseTaskDir=/druid/data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        druid.indexer.runner.type=k8s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        druid.peon.mode=remote</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        druid.indexer.task.encapsulatedTask=true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="properties">Properties<a href="#properties" class="hash-link" aria-label="Direct link to Properties" title="Direct link to Properties">​</a></h3><table><thead><tr><th>Property</th><th>Possible Values</th><th>Description</th><th>Default</th><th>required</th></tr></thead><tbody><tr><td><code>druid.indexer.runner.debugJobs</code></td><td><code>boolean</code></td><td>Clean up K8s jobs after tasks complete.</td><td>False</td><td>No</td></tr><tr><td><code>druid.indexer.runner.sidecarSupport</code></td><td><code>boolean</code></td><td>Deprecated, specify adapter type as runtime property <code>druid.indexer.runner.k8s.adapter.type: overlordMultiContainer</code> instead. If your overlord pod has sidecars, this will attempt to start the task with the same sidecars as the overlord pod.</td><td>False</td><td>No</td></tr><tr><td><code>druid.indexer.runner.primaryContainerName</code></td><td><code>String</code></td><td>If running with sidecars, the <code>primaryContainerName</code> should be that of your druid container like <code>druid-overlord</code>.</td><td>First container in <code>podSpec</code> list</td><td>No</td></tr><tr><td><code>druid.indexer.runner.kubexitImage</code></td><td><code>String</code></td><td>Used kubexit project to help shutdown sidecars when the main pod completes.  Otherwise jobs with sidecars never terminate.</td><td>karlkfi/kubexit:latest</td><td>No</td></tr><tr><td><code>druid.indexer.runner.disableClientProxy</code></td><td><code>boolean</code></td><td>Use this if you have a global http(s) proxy and you wish to bypass it.</td><td>false</td><td>No</td></tr><tr><td><code>druid.indexer.runner.maxTaskDuration</code></td><td><code>Duration</code></td><td>Max time a task is allowed to run for before getting killed</td><td><code>PT4H</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.taskCleanupDelay</code></td><td><code>Duration</code></td><td>How long do jobs stay around before getting reaped from K8s</td><td><code>P2D</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.taskCleanupInterval</code></td><td><code>Duration</code></td><td>How often to check for jobs to be reaped</td><td><code>PT10M</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.K8sjobLaunchTimeout</code></td><td><code>Duration</code></td><td>How long to wait to launch a K8s task before marking it as failed, on a resource constrained cluster it may take some time.</td><td><code>PT1H</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.javaOptsArray</code></td><td><code>JsonArray</code></td><td>java opts for the task.</td><td><code>-Xmx1g</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.labels</code></td><td><code>JsonObject</code></td><td>Additional labels you want to add to peon pod</td><td><code>{}</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.annotations</code></td><td><code>JsonObject</code></td><td>Additional annotations you want to add to peon pod</td><td><code>{}</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.peonMonitors</code></td><td><code>JsonArray</code></td><td>Overrides <code>druid.monitoring.monitors</code>. Use this property if you don&#x27;t want to inherit monitors from the Overlord.</td><td><code>[]</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.graceTerminationPeriodSeconds</code></td><td><code>Long</code></td><td>Number of seconds you want to wait after a sigterm for container lifecycle hooks to complete.  Keep at a smaller value if you want tasks to hold locks for shorter periods.</td><td><code>PT30S</code> (K8s default)</td><td>No</td></tr><tr><td><code>druid.indexer.runner.capacity</code></td><td><code>Integer</code></td><td>Number of concurrent jobs that can be sent to Kubernetes.</td><td><code>2147483647</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.cpuCoreInMicro</code></td><td><code>Integer</code></td><td>Number of CPU micro core for the task.</td><td><code>1000</code></td><td>No</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="metrics-added">Metrics added<a href="#metrics-added" class="hash-link" aria-label="Direct link to Metrics added" title="Direct link to Metrics added">​</a></h3><table><thead><tr><th>Metric</th><th>Description</th><th>Dimensions</th><th>Normal value</th></tr></thead><tbody><tr><td><code>k8s/peon/startup/time</code></td><td>Metric indicating the milliseconds for peon pod to startup.</td><td><code>dataSource</code>, <code>taskId</code>, <code>taskType</code>, <code>groupId</code>, <code>taskStatus</code>, <code>tags</code></td><td>Varies</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gotchas">Gotchas<a href="#gotchas" class="hash-link" aria-label="Direct link to Gotchas" title="Direct link to Gotchas">​</a></h3><ul><li><p>All Druid Pods belonging to one Druid cluster must be inside the same Kubernetes namespace.</p></li><li><p>You must have a role binding for the overlord&#x27;s service account that provides the needed permissions for interacting with Kubernetes. An example spec could be:</p></li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Role</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: &lt;druid-namespace&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: druid-k8s-task-scheduler</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rules:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - apiGroups: [&quot;batch&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    resources: [&quot;jobs&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;, &quot;delete&quot;, &quot;create&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - apiGroups: [&quot;&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    resources: [&quot;pods&quot;, &quot;pods/log&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    verbs: [&quot;get&quot;, &quot;watch&quot;, &quot;list&quot;, &quot;delete&quot;, &quot;create&quot;]</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">---</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">kind: RoleBinding</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: rbac.authorization.k8s.io/v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: druid-k8s-binding</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: &lt;druid-namespace&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">subjects:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  - kind: ServiceAccount</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    name: &lt;druid-overlord-k8s-service-account&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    namespace: &lt;druid-namespace&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">roleRef:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  kind: Role</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name: druid-k8s-task-scheduler</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  apiGroup: rbac.authorization.k8s.io</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="migrationkubernetes-and-worker-task-runner">Migration/Kubernetes and Worker Task Runner<a href="#migrationkubernetes-and-worker-task-runner" class="hash-link" aria-label="Direct link to Migration/Kubernetes and Worker Task Runner" title="Direct link to Migration/Kubernetes and Worker Task Runner">​</a></h2><p>If you are running a cluster with tasks running on middle managers or indexers and want to do a zero downtime migration to mm-less ingestion, the mm-less ingestion system is capable of running in migration mode by reading tasks from middle managers/indexers and Kubernetes and writing tasks to either middle managers or to Kubernetes.</p><p>To do this, set the following property.
<code>druid.indexer.runner.type: k8sAndWorker</code> (instead of <code>druid.indexer.runner.type: k8s</code>)</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="additional-configurations">Additional Configurations<a href="#additional-configurations" class="hash-link" aria-label="Direct link to Additional Configurations" title="Direct link to Additional Configurations">​</a></h3><table><thead><tr><th>Property</th><th>Possible Values</th><th>Description</th><th>Default</th><th>required</th></tr></thead><tbody><tr><td><code>druid.indexer.runner.k8sAndWorker.runnerStrategy.type</code></td><td><code>String</code> (e.g., <code>k8s</code>, <code>worker</code>, <code>taskType</code>)</td><td>Defines the strategy for task runner selection.</td><td><code>k8s</code></td><td>No</td></tr><tr><td><code>druid.indexer.runner.k8sAndWorker.runnerStrategy.workerType</code></td><td><code>String</code> (e.g., <code>httpRemote</code>, <code>remote</code>)</td><td>Specifies the variant of the worker task runner to be utilized.</td><td><code>httpRemote</code></td><td>No</td></tr><tr><td><strong>For <code>taskType</code> runner strategy:</strong></td><td></td><td></td><td></td><td></td></tr><tr><td><code>druid.indexer.runner.k8sAndWorker.runnerStrategy.taskType.default</code></td><td><code>String</code> (e.g., <code>k8s</code>, <code>worker</code>)</td><td>Specifies the default runner to use if no overrides apply. This setting ensures there is always a fallback runner available.</td><td>None</td><td>No</td></tr><tr><td><code>druid.indexer.runner.k8sAndWorker.runnerStrategy.taskType.overrides</code></td><td><code>JsonObject</code>(e.g., <code>{&quot;index_kafka&quot;: &quot;worker&quot;}</code>)</td><td>Defines task-specific overrides for runner types. Each entry sets a task type to a specific runner, allowing fine control.</td><td><code>{}</code></td><td>No</td></tr></tbody></table></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#how-it-works" class="table-of-contents__link toc-highlight">How it works</a></li><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#pod-adapters" class="table-of-contents__link toc-highlight">Pod Adapters</a><ul><li><a href="#overlord-single-container-pod-adapteroverlord-multi-container-pod-adapter" class="table-of-contents__link toc-highlight">Overlord Single Container Pod Adapter/Overlord Multi Container Pod Adapter</a></li><li><a href="#custom-template-pod-adapter" class="table-of-contents__link toc-highlight">Custom Template Pod Adapter</a></li><li><a href="#properties" class="table-of-contents__link toc-highlight">Properties</a></li><li><a href="#metrics-added" class="table-of-contents__link toc-highlight">Metrics added</a></li><li><a href="#gotchas" class="table-of-contents__link toc-highlight">Gotchas</a></li></ul></li><li><a href="#migrationkubernetes-and-worker-task-runner" class="table-of-contents__link toc-highlight">Migration/Kubernetes and Worker Task Runner</a><ul><li><a href="#additional-configurations" class="table-of-contents__link toc-highlight">Additional Configurations</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/favicon.png" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/favicon.png" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright © 2023 Apache Software Foundation. Except where otherwise noted, licensed under CC BY-SA 4.0. Apache Druid, Druid, and the Druid logo are either registered trademarks or trademarks of The Apache Software Foundation in the United States and other countries.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.042a693d.js"></script>
<script src="/assets/js/main.159ed78c.js"></script>
</body>
</html>