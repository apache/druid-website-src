"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[454],{3124:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>o,default:()=>a,frontMatter:()=>d,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"development/extensions-contrib/aliyun-oss","title":"Aliyun OSS","description":"\x3c!--","source":"@site/docs/32.0.0/development/extensions-contrib/aliyun-oss-extensions.md","sourceDirName":"development/extensions-contrib","slug":"/development/extensions-contrib/aliyun-oss","permalink":"/docs/32.0.0/development/extensions-contrib/aliyun-oss","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"aliyun-oss","title":"Aliyun OSS"}}');var r=n(74848),t=n(28453);const d={id:"aliyun-oss",title:"Aliyun OSS"},o=void 0,c={},l=[{value:"Installation",id:"installation",level:2},{value:"Enabling",id:"enabling",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Reading data from OSS",id:"reading-data-from-oss",level:2},{value:"OSS Input Source",id:"oss-input-source",level:3},{value:"OSS Object",id:"oss-object",level:4},{value:"Properties Object",id:"properties-object",level:4},{value:"Reading from a file",id:"reading-from-a-file",level:3},{value:"Reading files in folders",id:"reading-files-in-folders",level:3},{value:"Reading from other buckets",id:"reading-from-other-buckets",level:3},{value:"Reading with customized accessKey",id:"reading-with-customized-accesskey",level:3},{value:"Troubleshooting",id:"troubleshooting",level:2}];function h(e){const s={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(s.p,{children:[(0,r.jsx)(s.a,{href:"https://www.aliyun.com",children:"Alibaba Cloud"})," is the 3rd largest cloud infrastructure provider in the world. It provides its own storage solution known as OSS, ",(0,r.jsx)(s.a,{href:"https://www.aliyun.com/product/oss",children:"Object Storage Service"}),".\nThis document describes how to use OSS as Druid deep storage."]}),"\n",(0,r.jsx)(s.h2,{id:"installation",children:"Installation"}),"\n",(0,r.jsxs)(s.p,{children:["Use the ",(0,r.jsx)(s.a,{href:"/docs/32.0.0/operations/pull-deps",children:"pull-deps"})," tool shipped with Druid to install the ",(0,r.jsx)(s.code,{children:"aliyun-oss-extensions"})," extension, as described ",(0,r.jsx)(s.a,{href:"/docs/32.0.0/configuration/extensions#community-extensions",children:"here"})," on middle manager and historical nodes."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-bash",children:'java -classpath "{YOUR_DRUID_DIR}/lib/*" org.apache.druid.cli.Main tools pull-deps -c org.apache.druid.extensions.contrib:aliyun-oss-extensions:{YOUR_DRUID_VERSION}\n'})}),"\n",(0,r.jsx)(s.h2,{id:"enabling",children:"Enabling"}),"\n",(0,r.jsxs)(s.p,{children:["After installation, add this ",(0,r.jsx)(s.code,{children:"aliyun-oss-extensions"})," extension to ",(0,r.jsx)(s.code,{children:"druid.extensions.loadList"})," in common.runtime.properties and then restart middle manager and historical nodes."]}),"\n",(0,r.jsx)(s.h2,{id:"configuration",children:"Configuration"}),"\n",(0,r.jsx)(s.p,{children:"First add the following OSS configurations to common.runtime.properties"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Property"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Required"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.oss.accessKey"})}),(0,r.jsxs)(s.td,{children:["The ",(0,r.jsx)(s.code,{children:"AccessKey ID"})," of the account to be used to access the OSS bucket"]}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.oss.secretKey"})}),(0,r.jsxs)(s.td,{children:["The ",(0,r.jsx)(s.code,{children:"AccessKey Secret"})," of the account to be used to access the OSS bucket"]}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.oss.endpoint"})}),(0,r.jsxs)(s.td,{children:["The endpoint URL of your OSS storage. ",(0,r.jsx)("br",{}),"If your Druid cluster is also hosted in the same region on Alibaba Cloud as the region of your OSS bucket, it's recommended to use the internal network endpoint url, so that any inbound and outbound traffic to the OSS bucket is free of charge."]}),(0,r.jsx)(s.td,{children:"yes"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"To use OSS as deep storage, add the following configurations:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Property"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Required"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.storage.type"})}),(0,r.jsxs)(s.td,{children:["Global deep storage provider. Must be set to ",(0,r.jsx)(s.code,{children:"oss"})," to make use of this extension."]}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.storage.oss.bucket"})}),(0,r.jsx)(s.td,{children:"Storage bucket name."}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.storage.oss.prefix"})}),(0,r.jsxs)(s.td,{children:["Folder where segments will be published to. ",(0,r.jsx)(s.code,{children:"druid/segments"})," is recommended."]}),(0,r.jsx)(s.td,{children:"No"})]})]})]}),"\n",(0,r.jsx)(s.p,{children:"If OSS is used as deep storage for segment files, it's also recommended saving index logs in the OSS too.\nTo do this, add following configurations:"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Property"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Required"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.indexer.logs.type"})}),(0,r.jsxs)(s.td,{children:["Global deep storage provider. Must be set to ",(0,r.jsx)(s.code,{children:"oss"})," to make use of this extension."]}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.indexer.logs.oss.bucket"})}),(0,r.jsxs)(s.td,{children:["The bucket used to keep logs. It could be the same as ",(0,r.jsx)(s.code,{children:"druid.storage.oss.bucket"})]}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:(0,r.jsx)(s.code,{children:"druid.indexer.logs.oss.prefix"})}),(0,r.jsxs)(s.td,{children:["Folder where log files will be published to. ",(0,r.jsx)(s.code,{children:"druid/logs"})," is recommended."]}),(0,r.jsx)(s.td,{children:"no"})]})]})]}),"\n",(0,r.jsx)(s.h2,{id:"reading-data-from-oss",children:"Reading data from OSS"}),"\n",(0,r.jsx)(s.p,{children:"Currently, Web Console does not support ingestion from OSS, but it could be done by submitting an ingestion task with OSS's input source configuration."}),"\n",(0,r.jsx)(s.p,{children:"Below shows the configurations of OSS's input source."}),"\n",(0,r.jsx)(s.h3,{id:"oss-input-source",children:"OSS Input Source"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"property"}),(0,r.jsx)(s.th,{children:"description"}),(0,r.jsx)(s.th,{children:"Required"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"type"}),(0,r.jsxs)(s.td,{children:["This should be ",(0,r.jsx)(s.code,{children:"oss"}),"."]}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"uris"}),(0,r.jsxs)(s.td,{children:["JSON array of URIs where OSS objects to be ingested are located.",(0,r.jsx)("br",{}),"For example, ",(0,r.jsx)(s.code,{children:"oss://{your_bucket}/{source_file_path}"})]}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"uris"})," or ",(0,r.jsx)(s.code,{children:"prefixes"})," or ",(0,r.jsx)(s.code,{children:"objects"})," must be set"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"prefixes"}),(0,r.jsx)(s.td,{children:"JSON array of URI prefixes for the locations of OSS objects to be ingested. Empty objects starting with one of the given prefixes will be skipped."}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"uris"})," or ",(0,r.jsx)(s.code,{children:"prefixes"})," or ",(0,r.jsx)(s.code,{children:"objects"})," must be set"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"objects"}),(0,r.jsxs)(s.td,{children:["JSON array of ",(0,r.jsx)(s.a,{href:"#oss-object",children:"OSS Objects"})," to be ingested."]}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.code,{children:"uris"})," or ",(0,r.jsx)(s.code,{children:"prefixes"})," or ",(0,r.jsx)(s.code,{children:"objects"})," must be set"]})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"properties"}),(0,r.jsxs)(s.td,{children:[(0,r.jsx)(s.a,{href:"#properties-object",children:"Properties Object"})," for overriding the default OSS configuration. See below for more information."]}),(0,r.jsx)(s.td,{children:"no (defaults will be used if not given)"})]})]})]}),"\n",(0,r.jsx)(s.h4,{id:"oss-object",children:"OSS Object"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Property"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Default"}),(0,r.jsx)(s.th,{children:"Required"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"bucket"}),(0,r.jsx)(s.td,{children:"Name of the OSS bucket"}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"path"}),(0,r.jsx)(s.td,{children:"The path where data is located."}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"yes"})]})]})]}),"\n",(0,r.jsx)(s.h4,{id:"properties-object",children:"Properties Object"}),"\n",(0,r.jsxs)(s.table,{children:[(0,r.jsx)(s.thead,{children:(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.th,{children:"Property"}),(0,r.jsx)(s.th,{children:"Description"}),(0,r.jsx)(s.th,{children:"Default"}),(0,r.jsx)(s.th,{children:"Required"})]})}),(0,r.jsxs)(s.tbody,{children:[(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"accessKey"}),(0,r.jsxs)(s.td,{children:["The ",(0,r.jsx)(s.a,{href:"/docs/32.0.0/operations/password-provider",children:"Password Provider"})," or plain text string of this OSS InputSource's access key"]}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"secretKey"}),(0,r.jsxs)(s.td,{children:["The ",(0,r.jsx)(s.a,{href:"/docs/32.0.0/operations/password-provider",children:"Password Provider"})," or plain text string of this OSS InputSource's secret key"]}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"yes"})]}),(0,r.jsxs)(s.tr,{children:[(0,r.jsx)(s.td,{children:"endpoint"}),(0,r.jsx)(s.td,{children:"The endpoint of this OSS InputSource"}),(0,r.jsx)(s.td,{children:"None"}),(0,r.jsx)(s.td,{children:"no"})]})]})]}),"\n",(0,r.jsx)(s.h3,{id:"reading-from-a-file",children:"Reading from a file"}),"\n",(0,r.jsxs)(s.p,{children:["Say that the file ",(0,r.jsx)(s.code,{children:"rollup-data.json"}),", which can be found under Druid's ",(0,r.jsx)(s.code,{children:"quickstart/tutorial"})," directory, has been uploaded to a folder ",(0,r.jsx)(s.code,{children:"druid"})," in your OSS bucket, the bucket for which your Druid is configured.\nIn this case, the ",(0,r.jsx)(s.code,{children:"uris"})," property of the OSS's input source can be used for reading, as shown:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-json",children:'{\n  "type" : "index_parallel",\n  "spec" : {\n    "dataSchema" : {\n      "dataSource" : "rollup-tutorial-from-oss",\n      "timestampSpec": {\n        "column": "timestamp",\n        "format": "iso"\n      },\n      "dimensionsSpec" : {\n        "dimensions" : [\n          "srcIP",\n          "dstIP"\n        ]\n      },\n      "metricsSpec" : [\n        { "type" : "count", "name" : "count" },\n        { "type" : "longSum", "name" : "packets", "fieldName" : "packets" },\n        { "type" : "longSum", "name" : "bytes", "fieldName" : "bytes" }\n      ],\n      "granularitySpec" : {\n        "type" : "uniform",\n        "segmentGranularity" : "week",\n        "queryGranularity" : "minute",\n        "intervals" : ["2018-01-01/2018-01-03"],\n        "rollup" : true\n      }\n    },\n    "ioConfig" : {\n      "type" : "index_parallel",\n      "inputSource" : {\n        "type" : "oss",\n        "uris" : [\n          "oss://{YOUR_BUCKET_NAME}/druid/rollup-data.json"\n        ]\n      },\n      "inputFormat" : {\n        "type" : "json"\n      },\n      "appendToExisting" : false\n    },\n    "tuningConfig" : {\n      "type" : "index_parallel",\n      "maxRowsPerSegment" : 5000000,\n      "maxRowsInMemory" : 25000\n    }\n  }\n}\n'})}),"\n",(0,r.jsxs)(s.p,{children:["By posting the above ingestion task spec to ",(0,r.jsx)(s.code,{children:"http://{YOUR_ROUTER_IP}:8888/druid/indexer/v1/task"}),", an ingestion task will be created by the indexing service to ingest."]}),"\n",(0,r.jsx)(s.h3,{id:"reading-files-in-folders",children:"Reading files in folders"}),"\n",(0,r.jsxs)(s.p,{children:["If we want to read files in a same folder, we could use the ",(0,r.jsx)(s.code,{children:"prefixes"})," property to specify the folder name where Druid could find input files instead of specifying file URIs one by one."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-json",children:'...\n    "ioConfig" : {\n      "type" : "index_parallel",\n      "inputSource" : {\n        "type" : "oss",\n        "prefixes" : [\n          "oss://{YOUR_BUCKET_NAME}/2020", "oss://{YOUR_BUCKET_NAME}/2021"\n        ]\n      },\n      "inputFormat" : {\n        "type" : "json"\n      },\n      "appendToExisting" : false\n    }\n...\n'})}),"\n",(0,r.jsxs)(s.p,{children:["The spec above tells the ingestion task to read all files under ",(0,r.jsx)(s.code,{children:"2020"})," and ",(0,r.jsx)(s.code,{children:"2021"})," folders."]}),"\n",(0,r.jsx)(s.h3,{id:"reading-from-other-buckets",children:"Reading from other buckets"}),"\n",(0,r.jsxs)(s.p,{children:["If you want to read from files in buckets which are different from the bucket Druid is configured, use ",(0,r.jsx)(s.code,{children:"objects"})," property of OSS's InputSource for task submission as below:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-json",children:'...\n    "ioConfig" : {\n      "type" : "index_parallel",\n      "inputSource" : {\n        "type" : "oss",\n        "objects" : [\n          {"bucket": "YOUR_BUCKET_NAME", "path": "druid/rollup-data.json"}\n        ]\n      },\n      "inputFormat" : {\n        "type" : "json"\n      },\n      "appendToExisting" : false\n    }\n...\n'})}),"\n",(0,r.jsx)(s.h3,{id:"reading-with-customized-accesskey",children:"Reading with customized accessKey"}),"\n",(0,r.jsxs)(s.p,{children:["If the default ",(0,r.jsx)(s.code,{children:"druid.oss.accessKey"})," is not able to access a bucket, ",(0,r.jsx)(s.code,{children:"properties"})," could be used to customize these secret information as below:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-json",children:'...\n    "ioConfig" : {\n      "type" : "index_parallel",\n      "inputSource" : {\n        "type" : "oss",\n        "objects" : [\n          {"bucket": "YOUR_BUCKET_NAME", "path": "druid/rollup-data.json"}\n        ],\n        "properties": {\n          "endpoint": "YOUR_ENDPOINT_OF_BUCKET",\n          "accessKey": "YOUR_ACCESS_KEY",\n          "secretKey": "YOUR_SECRET_KEY"\n        }\n      },\n      "inputFormat" : {\n        "type" : "json"\n      },\n      "appendToExisting" : false\n    }\n...\n'})}),"\n",(0,r.jsxs)(s.p,{children:["This ",(0,r.jsx)(s.code,{children:"properties"})," could be applied to any of ",(0,r.jsx)(s.code,{children:"uris"}),", ",(0,r.jsx)(s.code,{children:"objects"}),", ",(0,r.jsx)(s.code,{children:"prefixes"})," property above."]}),"\n",(0,r.jsx)(s.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,r.jsxs)(s.p,{children:["When using OSS as deep storage or reading from OSS, the most problems that users will encounter are related to OSS permission.\nPlease refer to the official ",(0,r.jsx)(s.a,{href:"https://www.alibabacloud.com/help/doc-detail/42777.htm",children:"OSS permission troubleshooting document"})," to find a solution."]})]})}function a(e={}){const{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},28453:(e,s,n)=>{n.d(s,{R:()=>d,x:()=>o});var i=n(96540);const r={},t=i.createContext(r);function d(e){const s=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(t.Provider,{value:s},e.children)}}}]);