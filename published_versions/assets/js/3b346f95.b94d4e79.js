"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[1951],{28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var r=s(96540);const t={},i=r.createContext(t);function o(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},95309:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"development/extensions-core/protobuf","title":"Protobuf","description":"\x3c!--","source":"@site/docs/32.0.0/development/extensions-core/protobuf.md","sourceDirName":"development/extensions-core","slug":"/development/extensions-core/protobuf","permalink":"/docs/32.0.0/development/extensions-core/protobuf","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"protobuf","title":"Protobuf"}}');var t=s(74848),i=s(28453);const o={id:"protobuf",title:"Protobuf"},c=void 0,a={},d=[{value:"Example: Load Protobuf messages from Kafka",id:"example-load-protobuf-messages-from-kafka",level:2},{value:"Proto file",id:"proto-file",level:3},{value:"When using a descriptor file",id:"when-using-a-descriptor-file",level:3},{value:"When using Schema Registry",id:"when-using-schema-registry",level:3},{value:"Create Kafka Supervisor",id:"create-kafka-supervisor",level:2},{value:"When using a descriptor file",id:"when-using-a-descriptor-file-1",level:3},{value:"When using Schema Registry",id:"when-using-schema-registry-1",level:3},{value:"Adding Protobuf messages to Kafka",id:"adding-protobuf-messages-to-kafka",level:2},{value:"Generating the example files",id:"generating-the-example-files",level:2},{value:"<code>metrics.desc</code>",id:"metricsdesc",level:3},{value:"<code>metrics_pb2.py</code>",id:"metrics_pb2py",level:3},{value:"<code>pb_publisher.py</code>",id:"pb_publisherpy",level:3}];function l(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["This Apache Druid extension enables Druid to ingest and understand the Protobuf data format. Make sure to ",(0,t.jsx)(n.a,{href:"/docs/32.0.0/configuration/extensions#loading-extensions",children:"include"})," ",(0,t.jsx)(n.code,{children:"druid-protobuf-extensions"})," in the extensions load list."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"druid-protobuf-extensions"})," provides the ",(0,t.jsx)(n.a,{href:"/docs/32.0.0/ingestion/data-formats#protobuf-parser",children:"Protobuf Parser"}),"\nfor ",(0,t.jsx)(n.a,{href:"/docs/32.0.0/ingestion/#streaming",children:"stream ingestion"}),". See corresponding docs for details."]}),"\n",(0,t.jsx)(n.h2,{id:"example-load-protobuf-messages-from-kafka",children:"Example: Load Protobuf messages from Kafka"}),"\n",(0,t.jsxs)(n.p,{children:["This example demonstrates how to load Protobuf messages from Kafka.  Please read the ",(0,t.jsx)(n.a,{href:"/docs/32.0.0/tutorials/tutorial-kafka",children:"Load from Kafka tutorial"})," first, and see ",(0,t.jsx)(n.a,{href:"/docs/32.0.0/ingestion/kafka-ingestion",children:"Kafka Indexing Service"})," documentation for more details."]}),"\n",(0,t.jsxs)(n.p,{children:["The files used in this example are found at ",(0,t.jsxs)(n.a,{href:"https://github.com/apache/druid/tree/master/examples/quickstart/protobuf",children:[(0,t.jsx)(n.code,{children:"./examples/quickstart/protobuf"})," in your Druid directory"]}),"."]}),"\n",(0,t.jsx)(n.p,{children:"For this example:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Kafka broker host is ",(0,t.jsx)(n.code,{children:"localhost:9092"})]}),"\n",(0,t.jsxs)(n.li,{children:["Kafka topic is ",(0,t.jsx)(n.code,{children:"metrics_pb"})]}),"\n",(0,t.jsxs)(n.li,{children:["Datasource name is ",(0,t.jsx)(n.code,{children:"metrics-protobuf"})]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Here is a JSON example of the 'metrics' data schema used in the example."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "unit": "milliseconds",\n  "http_method": "GET",\n  "value": 44,\n  "timestamp": "2017-04-06T02:36:22Z",\n  "http_code": "200",\n  "page": "/",\n  "metricType": "request/latency",\n  "server": "www1.example.com"\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"proto-file",children:"Proto file"}),"\n",(0,t.jsxs)(n.p,{children:["The corresponding proto file for our 'metrics' dataset looks like this. You can use Protobuf ",(0,t.jsx)(n.code,{children:"inputFormat"})," with a proto file or ",(0,t.jsx)(n.a,{href:"https://docs.confluent.io/platform/current/schema-registry/index.html",children:"Confluent Schema Registry"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'syntax = "proto3";\nmessage Metrics {\n  string unit = 1;\n  string http_method = 2;\n  int32 value = 3;\n  string timestamp = 4;\n  string http_code = 5;\n  string page = 6;\n  string metricType = 7;\n  string server = 8;\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"when-using-a-descriptor-file",children:"When using a descriptor file"}),"\n",(0,t.jsxs)(n.p,{children:["Next, we use the ",(0,t.jsx)(n.code,{children:"protoc"})," Protobuf compiler to generate the descriptor file and save it as ",(0,t.jsx)(n.code,{children:"metrics.desc"}),". The descriptor file must be either in the classpath or reachable by URL.  In this example the descriptor file was saved at ",(0,t.jsx)(n.code,{children:"/tmp/metrics.desc"}),", however this file is also available in the example files. From your Druid install directory:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"protoc -o /tmp/metrics.desc ./quickstart/protobuf/metrics.proto\n"})}),"\n",(0,t.jsx)(n.h3,{id:"when-using-schema-registry",children:"When using Schema Registry"}),"\n",(0,t.jsx)(n.p,{children:"Make sure your Schema Registry version is later than 5.5. Next, we can post a schema to add it to the registry:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'POST /subjects/test/versions HTTP/1.1\nHost: schemaregistry.example1.com\nAccept: application/vnd.schemaregistry.v1+json, application/vnd.schemaregistry+json, application/json\n\n{\n    "schemaType": "PROTOBUF",\n    "schema": "syntax = \\"proto3\\";\\nmessage Metrics {\\n  string unit = 1;\\n  string http_method = 2;\\n  int32 value = 3;\\n string timestamp = 4;\\n string http_code = 5;\\n string page = 6;\\n string metricType = 7;\\n string server = 8;\\n}\\n"\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"This feature uses Confluent's Protobuf provider which is not included in the Druid distribution and must be installed separately. You can fetch it and its dependencies from the Confluent repository and Maven Central at:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://packages.confluent.io/maven/io/confluent/kafka-protobuf-provider/6.0.1/kafka-protobuf-provider-6.0.1.jar",children:"https://packages.confluent.io/maven/io/confluent/kafka-protobuf-provider/6.0.1/kafka-protobuf-provider-6.0.1.jar"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://repo1.maven.org/maven2/org/jetbrains/kotlin/kotlin-stdlib/1.4.0/kotlin-stdlib-1.4.0.jar",children:"https://repo1.maven.org/maven2/org/jetbrains/kotlin/kotlin-stdlib/1.4.0/kotlin-stdlib-1.4.0.jar"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://repo1.maven.org/maven2/com/squareup/wire/wire-schema/3.2.2/wire-schema-3.2.2.jar",children:"https://repo1.maven.org/maven2/com/squareup/wire/wire-schema/3.2.2/wire-schema-3.2.2.jar"})}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Copy or symlink those files inside the folder ",(0,t.jsx)(n.code,{children:"extensions-core/protobuf-extensions"})," under the distribution root directory."]}),"\n",(0,t.jsx)(n.h2,{id:"create-kafka-supervisor",children:"Create Kafka Supervisor"}),"\n",(0,t.jsx)(n.p,{children:"Below is the complete Supervisor spec JSON to be submitted to the Overlord.\nMake sure these keys are properly configured for successful ingestion."}),"\n",(0,t.jsx)(n.h3,{id:"when-using-a-descriptor-file-1",children:"When using a descriptor file"}),"\n",(0,t.jsx)(n.p,{children:"Important supervisor properties"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.descriptor"})," for the descriptor file URL"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.protoMessageType"})," from the proto definition"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.type"})," set to ",(0,t.jsx)(n.code,{children:"file"}),", indicate use descriptor file to decode Protobuf file"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"inputFormat"})," should have ",(0,t.jsx)(n.code,{children:"type"})," set to ",(0,t.jsx)(n.code,{children:"protobuf"})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n"type": "kafka",\n"spec": {\n    "dataSchema": {\n        "dataSource": "metrics-protobuf",\n        "timestampSpec": {\n            "column": "timestamp",\n            "format": "auto"\n        },\n        "dimensionsSpec": {\n            "dimensions": [\n                "unit",\n                "http_method",\n                "http_code",\n                "page",\n                "metricType",\n                "server"\n            ],\n            "dimensionExclusions": [\n                "timestamp",\n                "value"\n            ]\n        },\n        "metricsSpec": [\n            {\n                "name": "count",\n                "type": "count"\n            },\n            {\n                "name": "value_sum",\n                "fieldName": "value",\n                "type": "doubleSum"\n            },\n            {\n                "name": "value_min",\n                "fieldName": "value",\n                "type": "doubleMin"\n            },\n            {\n                "name": "value_max",\n                "fieldName": "value",\n                "type": "doubleMax"\n            }\n        ],\n        "granularitySpec": {\n            "type": "uniform",\n            "segmentGranularity": "HOUR",\n            "queryGranularity": "NONE"\n        }\n    },\n    "tuningConfig": {\n        "type": "kafka",\n        "maxRowsPerSegment": 5000000\n    },\n    "ioConfig": {\n        "topic": "metrics_pb",\n        "consumerProperties": {\n            "bootstrap.servers": "localhost:9092"\n        },\n        "inputFormat": {\n            "type": "protobuf",\n            "protoBytesDecoder": {\n                "type": "file",\n                "descriptor": "file:///tmp/metrics.desc",\n                "protoMessageType": "Metrics"\n            },\n            "flattenSpec": {\n                "useFieldDiscovery": true\n            },\n            "binaryAsString": false\n        },\n        "taskCount": 1,\n        "replicas": 1,\n        "taskDuration": "PT1H",\n        "type": "kafka"\n    }\n}\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"To adopt to old version. You can use old parser style, which also works."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "parser": {\n    "type": "protobuf",\n    "descriptor": "file:///tmp/metrics.desc",\n    "protoMessageType": "Metrics"\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"when-using-schema-registry-1",children:"When using Schema Registry"}),"\n",(0,t.jsx)(n.p,{children:"Important supervisor properties"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.url"})," for the schema registry URL with single instance."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.urls"})," for the schema registry URLs with multi instances."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.capacity"})," capacity for schema registry cached schemas."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.config"})," to send additional configurations, configured for Schema Registry."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.headers"})," to send headers to the Schema Registry."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"protoBytesDecoder.type"})," set to ",(0,t.jsx)(n.code,{children:"schema_registry"}),", indicate use schema registry to decode Protobuf file."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"parser"})," should have ",(0,t.jsx)(n.code,{children:"type"})," set to ",(0,t.jsx)(n.code,{children:"protobuf"}),", but note that the ",(0,t.jsx)(n.code,{children:"format"})," of the ",(0,t.jsx)(n.code,{children:"parseSpec"})," must be ",(0,t.jsx)(n.code,{children:"json"}),"."]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "parser": {\n    "type": "protobuf",\n    "protoBytesDecoder": {\n      "urls": ["http://schemaregistry.example1.com:8081","http://schemaregistry.example2.com:8081"],\n      "type": "schema_registry",\n      "capacity": 100,\n      "config" : {\n           "basic.auth.credentials.source": "USER_INFO",\n           "basic.auth.user.info": "fred:letmein",\n           "schema.registry.ssl.truststore.location": "/some/secrets/kafka.client.truststore.jks",\n           "schema.registry.ssl.truststore.password": "<password>",\n           "schema.registry.ssl.keystore.location": "/some/secrets/kafka.client.keystore.jks",\n           "schema.registry.ssl.keystore.password": "<password>",\n           "schema.registry.ssl.key.password": "<password>",\n             ... \n      },\n      "headers": {\n          "traceID" : "b29c5de2-0db4-490b-b421",\n          "timeStamp" : "1577191871865",\n          ...\n      }\n    }\n  }\n}\n'})}),"\n",(0,t.jsx)(n.h2,{id:"adding-protobuf-messages-to-kafka",children:"Adding Protobuf messages to Kafka"}),"\n",(0,t.jsx)(n.p,{children:"If necessary, from your Kafka installation directory run the following command to create the Kafka topic"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"./bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor 1 --partitions 1 --topic metrics_pb\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This example script requires ",(0,t.jsx)(n.code,{children:"protobuf"})," and ",(0,t.jsx)(n.code,{children:"kafka-python"})," modules. With the topic in place, messages can be inserted running the following command from your Druid installation directory"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"./bin/generate-example-metrics | python /quickstart/protobuf/pb_publisher.py\n"})}),"\n",(0,t.jsx)(n.p,{children:"You can confirm that data has been inserted to your Kafka topic using the following command from your Kafka installation directory"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"./bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic metrics_pb --from-beginning\n"})}),"\n",(0,t.jsx)(n.p,{children:"which should print messages like this"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'millisecondsGETR"2017-04-06T03:23:56Z*2002/list:request/latencyBwww1.example.com\n'})}),"\n",(0,t.jsx)(n.p,{children:"If your supervisor created in the previous step is running, the indexing tasks should begin producing the messages and the data will soon be available for querying in Druid."}),"\n",(0,t.jsx)(n.h2,{id:"generating-the-example-files",children:"Generating the example files"}),"\n",(0,t.jsxs)(n.p,{children:["The files provided in the example quickstart can be generated in the following manner starting with only ",(0,t.jsx)(n.code,{children:"metrics.proto"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"metricsdesc",children:(0,t.jsx)(n.code,{children:"metrics.desc"})}),"\n",(0,t.jsxs)(n.p,{children:["The descriptor file is generated using ",(0,t.jsx)(n.code,{children:"protoc"})," Protobuf compiler. Given a ",(0,t.jsx)(n.code,{children:".proto"})," file, a ",(0,t.jsx)(n.code,{children:".desc"})," file can be generated like so."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"protoc -o metrics.desc metrics.proto\n"})}),"\n",(0,t.jsx)(n.h3,{id:"metrics_pb2py",children:(0,t.jsx)(n.code,{children:"metrics_pb2.py"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"metrics_pb2.py"})," is also generated with ",(0,t.jsx)(n.code,{children:"protoc"})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:" protoc -o metrics.desc metrics.proto --python_out=.\n"})}),"\n",(0,t.jsx)(n.h3,{id:"pb_publisherpy",children:(0,t.jsx)(n.code,{children:"pb_publisher.py"})}),"\n",(0,t.jsxs)(n.p,{children:["After ",(0,t.jsx)(n.code,{children:"metrics_pb2.py"})," is generated, another script can be constructed to parse JSON data, convert it to Protobuf, and produce to a Kafka topic"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"#!/usr/bin/env python\n\nimport sys\nimport json\n\nfrom kafka import KafkaProducer\nfrom metrics_pb2 import Metrics\n\n\nproducer = KafkaProducer(bootstrap_servers='localhost:9092')\ntopic = 'metrics_pb'\n\nfor row in iter(sys.stdin):\n    d = json.loads(row)\n    metrics = Metrics()\n    for k, v in d.items():\n        setattr(metrics, k, v)\n    pb = metrics.SerializeToString()\n    producer.send(topic, pb)\n\nproducer.flush()\n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}}}]);