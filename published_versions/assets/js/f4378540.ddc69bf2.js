"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[6122],{20015:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>l,frontMatter:()=>s,metadata:()=>n,toc:()=>u});const n=JSON.parse('{"id":"querying/troubleshooting","title":"Troubleshooting query execution in Druid","description":"\x3c!--","source":"@site/docs/32.0.0/querying/troubleshooting.md","sourceDirName":"querying","slug":"/querying/troubleshooting","permalink":"/docs/32.0.0/querying/troubleshooting","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"troubleshooting","title":"Troubleshooting query execution in Druid","sidebar_label":"Troubleshooting"},"sidebar":"docs","previous":{"title":"Query execution","permalink":"/docs/32.0.0/querying/query-execution"},"next":{"title":"Datasources","permalink":"/docs/32.0.0/querying/datasource"}}');var i=t(74848),o=t(28453);const s={id:"troubleshooting",title:"Troubleshooting query execution in Druid",sidebar_label:"Troubleshooting"},a=void 0,c={},u=[{value:"Query fails due to internal communication timeout",id:"query-fails-due-to-internal-communication-timeout",level:2}];function d(e){const r={a:"a",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.p,{children:"This topic describes issues that may affect query execution in Druid, how to identify those issues, and strategies to resolve them."}),"\n",(0,i.jsx)(r.h2,{id:"query-fails-due-to-internal-communication-timeout",children:"Query fails due to internal communication timeout"}),"\n",(0,i.jsx)(r.p,{children:"In Druid's query processing, when the Broker sends a query to the data servers, the data servers process the query and push their intermediate results back to the Broker.\nBecause calls from the Broker to the data servers are synchronous, the Jetty server can time out in data servers in certain cases:"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsx)(r.li,{children:"The data servers don't push any results to the Broker before the maximum idle time."}),"\n",(0,i.jsxs)(r.li,{children:["The data servers started to push data but paused for longer than the maximum idle time such as due to ",(0,i.jsx)(r.a,{href:"/docs/32.0.0/operations/basic-cluster-tuning#broker-backpressure",children:"Broker backpressure"}),"."]}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"When such timeout occurs, the server interrupts the connection between the Broker and data servers which causes the query to fail with a channel disconnection error. For example,"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-json",children:'{\n   "error": {\n      "error": "Unknown exception",\n      "errorMessage": "Query[6eee73a6-a95f-4bdc-821d-981e99e39242] url[https://localhost:8283/druid/v2/] failed with exception msg [Channel disconnected] (through reference chain: org.apache.druid.query.scan.ScanResultValue[\\"segmentId\\"])",\n      "errorClass": "com.fasterxml.jackson.databind.JsonMappingException",\n      "host": "localhost:8283"\n   }\n}\n'})}),"\n",(0,i.jsxs)(r.p,{children:["Channel disconnection occurs for various reasons.\nTo verify that the error is due to web server timeout, search for the query ID in the Historical logs.\nThe query ID in the example above is ",(0,i.jsx)(r.code,{children:"6eee73a6-a95f-4bdc-821d-981e99e39242"}),".\nThe ",(0,i.jsx)(r.code,{children:'"host"'})," field in the error message above indicates the IP address of the Historical in question.\nIn the Historical logs, you will see a raised exception indicating ",(0,i.jsx)(r.code,{children:"Idle timeout expired"}),":"]}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{className:"language-text",children:"2021-09-14T19:52:27,685 ERROR [qtp475526834-85[scan_[test_large_table]_6eee73a6-a95f-4bdc-821d-981e99e39242]] org.apache.druid.server.QueryResource - Unable to send query response. (java.io.IOException: java.util.concurrent.TimeoutException: Idle timeout expired: 300000/300000 ms)\n2021-09-14T19:52:27,685 ERROR [qtp475526834-85] org.apache.druid.server.QueryLifecycle - Exception while processing queryId [6eee73a6-a95f-4bdc-821d-981e99e39242] (java.io.IOException: java.util.concurrent.TimeoutException: Idle timeout expired: 300000/300000 ms)\n2021-09-14T19:52:27,686 WARN [qtp475526834-85] org.eclipse.jetty.server.HttpChannel - handleException /druid/v2/ java.io.IOException: java.util.concurrent.TimeoutException: Idle timeout expired: 300000/300000 ms\n"})}),"\n",(0,i.jsx)(r.p,{children:"To mitigate query failure due to web server timeout:"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsxs)(r.li,{children:["Increase the max idle time for the web server.\nSet the max idle time in the ",(0,i.jsx)(r.code,{children:"druid.server.http.maxIdleTime"})," property in the ",(0,i.jsx)(r.code,{children:"historical/runtime.properties"})," file.\nYou must restart the Druid cluster for this change to take effect.\nSee ",(0,i.jsx)(r.a,{href:"/docs/32.0.0/configuration/",children:"Configuration reference"})," for more information on configuring the server."]}),"\n",(0,i.jsxs)(r.li,{children:["If the timeout occurs because the data servers have not pushed any results to the Broker, consider optimizing data server performance. Significant slowdown in the data servers may be a result of spilling too much data to disk in ",(0,i.jsx)(r.a,{href:"/docs/32.0.0/querying/groupbyquery#performance-tuning-for-groupby",children:"groupBy queries"}),", large ",(0,i.jsxs)(r.a,{href:"/docs/32.0.0/querying/filters#in-filter",children:[(0,i.jsx)(r.code,{children:"IN"})," filters"]})," in the query, or an under scaled cluster. Analyze your ",(0,i.jsx)(r.a,{href:"/docs/32.0.0/operations/metrics#query-metrics",children:"Druid query metrics"})," to determine the bottleneck."]}),"\n",(0,i.jsx)(r.li,{children:"If the timeout is caused by Broker backpressure, consider optimizing Broker performance. Check whether the connection is fast enough between the Broker and deep storage."}),"\n"]})]})}function l(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},28453:(e,r,t)=>{t.d(r,{R:()=>s,x:()=>a});var n=t(96540);const i={},o=n.createContext(i);function s(e){const r=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),n.createElement(o.Provider,{value:r},e.children)}}}]);