"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[6677],{28453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var t=i(96540);const r={},s=t.createContext(r);function a(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(s.Provider,{value:n},e.children)}},41039:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/tutorial-query-03-3bb6a7521f4fcc9bf410ab6bfa1fa63f.png"},48981:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>c,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"tutorials/tutorial-query","title":"Query data","description":"\x3c!--","source":"@site/docs/33.0.0/tutorials/tutorial-query.md","sourceDirName":"tutorials","slug":"/tutorials/tutorial-query","permalink":"/docs/33.0.0/tutorials/tutorial-query","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"tutorial-query","title":"Query data","sidebar_label":"Query data"},"sidebar":"docs","previous":{"title":"Query for latest data","permalink":"/docs/33.0.0/tutorials/tutorial-latest-by"},"next":{"title":"Get to know Query view","permalink":"/docs/33.0.0/tutorials/tutorial-sql-query-view"}}');var r=i(74848),s=i(28453);const a={id:"tutorial-query",title:"Query data",sidebar_label:"Query data"},o=void 0,l={},d=[{value:"Query SQL from the web console",id:"query-sql-from-the-web-console",level:2},{value:"More Druid SQL examples",id:"more-druid-sql-examples",level:2},{value:"Query over time",id:"query-over-time",level:3},{value:"General group by",id:"general-group-by",level:3},{value:"Query SQL over HTTP",id:"query-sql-over-http",level:2},{value:"Further reading",id:"further-reading",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"This tutorial demonstrates how to query data in Apache Druid using SQL."}),"\n",(0,r.jsxs)(n.p,{children:["It assumes that you've completed the ",(0,r.jsx)(n.a,{href:"/docs/33.0.0/tutorials/",children:"Quickstart"}),"\nor one of the following tutorials, since we'll query datasources that you would have created\nby following one of them:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/33.0.0/tutorials/tutorial-batch",children:"Load a file"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/33.0.0/tutorials/tutorial-kafka",children:"Load stream data from Kafka"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"/docs/33.0.0/tutorials/tutorial-batch-hadoop",children:"Load a file using Hadoop"})}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"There are various ways to run Druid SQL queries: from the web console, using a command line utility\nand by posting the query by HTTP. We'll look at each of these."}),"\n",(0,r.jsx)(n.h2,{id:"query-sql-from-the-web-console",children:"Query SQL from the web console"}),"\n",(0,r.jsx)(n.p,{children:"The web console includes a view that makes it easier to build and test queries, and\nview their results."}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Start up the Druid cluster, if it's not already running, and open the web console in your web\nbrowser."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Click ",(0,r.jsx)(n.strong,{children:"Query"})," from the header to open the Query view:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Query view",src:i(57053).A+"",title:"Query view",width:"1250",height:"640"})}),"\n",(0,r.jsx)(n.p,{children:"You can always write queries directly in the edit pane, but the Query view also provides\nfacilities to help you construct SQL queries, which we will use to generate a starter query."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Expand the wikipedia datasource tree in the left pane. We'll\ncreate a query for the page dimension."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Click ",(0,r.jsx)(n.code,{children:"page"})," and then ",(0,r.jsxs)(n.strong,{children:["Show",":page"]})," from the menu:"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Query select page",src:i(75846).A+"",title:"Query select page",width:"1250",height:"640"})}),"\n",(0,r.jsx)(n.p,{children:"A SELECT query appears in the query edit pane and immediately runs. However, in this case, the query\nreturns no data, since by default the query filters for data from the last day, while our data is considerably\nolder than that. Let's remove the filter."}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Click ",(0,r.jsx)(n.strong,{children:"Run"})," to run the query."]}),"\n",(0,r.jsx)(n.p,{children:"You should now see two columns of data, a page name and the count:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Query results",src:i(41039).A+"",title:"Query results",width:"1250",height:"640"})}),"\n",(0,r.jsxs)(n.p,{children:["Notice that the results are limited in the console to about a hundred, by default, due to the ",(0,r.jsx)(n.strong,{children:"Smart query limit"}),"\nfeature. This helps users avoid inadvertently running queries that return an excessive amount of data, possibly\noverwhelming their system."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Let's edit the query directly and take a look at a few more query building features in the editor.\nClick in the query edit pane and make the following changes:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Add a line after the first column, ",(0,r.jsx)(n.code,{children:'"page"'})," and Start typing the name of a new column, ",(0,r.jsx)(n.code,{children:'"countryName"'}),'. Notice that the autocomplete menu suggests column names, functions, keywords, and more. Choose "countryName" and\nadd the new column to the GROUP BY clause as well, either by name or by reference to its position, ',(0,r.jsx)(n.code,{children:"2"}),"."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["For readability, replace ",(0,r.jsx)(n.code,{children:"Count"})," column name with ",(0,r.jsx)(n.code,{children:"Edits"}),", since the ",(0,r.jsx)(n.code,{children:"COUNT()"})," function actually\nreturns the number of edits for the page. Make the same column name change in the ORDER BY clause as well."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"COUNT()"})," function is one of many functions available for use in Druid SQL queries. You can mouse over a function name\nin the autocomplete menu to see a brief description of a function. Also, you can find more information in the Druid\ndocumentation; for example, the ",(0,r.jsx)(n.code,{children:"COUNT()"})," function is documented in\n",(0,r.jsx)(n.a,{href:"/docs/33.0.0/querying/sql-aggregations",children:"Aggregation functions"}),"."]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"The query should now be:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'SELECT\n  "page",\n  "countryName",\n  COUNT(*) AS "Edits"\nFROM "wikipedia"\nGROUP BY 1, 2\nORDER BY "Edits" DESC\n'})}),"\n",(0,r.jsxs)(n.p,{children:["When you run the query again, notice that we're getting the new dimension,",(0,r.jsx)(n.code,{children:"countryName"}),", but for most of the rows, its value\nis null. Let's\nshow only rows with a ",(0,r.jsx)(n.code,{children:"countryName"})," value."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Click the ",(0,r.jsx)(n.code,{children:"countryName"})," dimension in the left pane and choose the first filtering option. It's not exactly what we want, but\nwe'll edit it by hand. The new WHERE clause should appear in your query."]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Modify the WHERE clause to exclude results that do not have a value for countryName:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'WHERE "countryName" IS NOT NULL\n'})}),"\n",(0,r.jsx)(n.p,{children:"Run the query again. You should now see the top edits by country:"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Finished query",src:i(72016).A+"",title:"Finished query",width:"1250",height:"640"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:["Under the covers, every Druid SQL query is translated into a query in the JSON-based ",(0,r.jsx)(n.em,{children:"Druid native query"})," format before it runs\non data nodes. You can view the native query for this query by clicking ",(0,r.jsx)(n.code,{children:"..."})," and ",(0,r.jsx)(n.strong,{children:"Explain SQL Query"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["While you can use Druid SQL for most purposes, familiarity with native query is useful for composing complex queries and for troubleshooting\nperformance issues. For more information, see ",(0,r.jsx)(n.a,{href:"/docs/33.0.0/querying/",children:"Native queries"}),"."]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Explain query",src:i(78265).A+"",title:"Explain query",width:"1250",height:"640"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{type:"info",children:[(0,r.jsx)(n.p,{children:"Another way to view the explain plan is by adding EXPLAIN PLAN FOR to the front of your query, as follows:"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:'EXPLAIN PLAN FOR\nSELECT\n  "page",\n  "countryName",\n  COUNT(*) AS "Edits"\nFROM "wikipedia"\nWHERE "countryName" IS NOT NULL\nGROUP BY 1, 2\nORDER BY "Edits" DESC\n'})}),(0,r.jsx)(n.p,{children:"This is particularly useful when running queries\nfrom the command line or over HTTP."})]}),"\n",(0,r.jsxs)(n.ol,{start:"9",children:["\n",(0,r.jsxs)(n.li,{children:["Finally, click  ",(0,r.jsx)(n.code,{children:"..."}),"  and ",(0,r.jsx)(n.strong,{children:"Edit context"})," to see how you can add additional parameters controlling the execution of the query execution. In the field, enter query context options as JSON key-value pairs, as described in ",(0,r.jsx)(n.a,{href:"/docs/33.0.0/querying/query-context",children:"Context flags"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"That's it! We've built a simple query using some of the query builder features built into the web console. The following\nsections provide a few more example queries you can try."}),"\n",(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"#query-sql-over-http",children:"Query SQL over HTTP"})," for an example of how to use the Druid SQL HTTP API."]}),"\n",(0,r.jsx)(n.h2,{id:"more-druid-sql-examples",children:"More Druid SQL examples"}),"\n",(0,r.jsx)(n.p,{children:"Try the following queries to learn a few more Druid SQL tricks:"}),"\n",(0,r.jsx)(n.h3,{id:"query-over-time",children:"Query over time"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT FLOOR(__time to HOUR) AS HourTime, SUM(deleted) AS LinesDeleted\nFROM wikipedia WHERE TIME_IN_INTERVAL(\"__time\", '2016-06-27/2016-06-28')\nGROUP BY 1\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Query example",src:i(95330).A+"",title:"Query example",width:"1250",height:"640"})}),"\n",(0,r.jsx)(n.h3,{id:"general-group-by",children:"General group by"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-sql",children:"SELECT channel, page, SUM(added)\nFROM wikipedia WHERE TIME_IN_INTERVAL(\"__time\", '2016-06-27/2016-06-28')\nGROUP BY channel, page\nORDER BY SUM(added) DESC\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"Query example",src:i(85835).A+"",title:"Query example",width:"1250",height:"640"})}),"\n",(0,r.jsx)(n.h2,{id:"query-sql-over-http",children:"Query SQL over HTTP"}),"\n",(0,r.jsxs)(n.p,{children:["You can submit native queries ",(0,r.jsx)(n.a,{href:"/docs/33.0.0/api-reference/sql-api#submit-a-query",children:"directly to the Druid Broker over HTTP"}),". The request body should be a JSON object, with the value for the key ",(0,r.jsx)(n.code,{children:"query"})," containing text of the query:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'{\n  "query": "SELECT page, COUNT(*) AS Edits FROM wikipedia WHERE TIME_IN_INTERVAL(\\"__time\\", \'2016-06-27/2016-06-28\') GROUP BY page ORDER BY Edits DESC LIMIT 10"\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The tutorial package includes an example file that contains the SQL query shown above at ",(0,r.jsx)(n.code,{children:"quickstart/tutorial/wikipedia-top-pages-sql.json"}),". Let's submit that query to the Druid Broker:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl -X 'POST' -H 'Content-Type:application/json' -d @quickstart/tutorial/wikipedia-top-pages-sql.json http://localhost:8888/druid/v2/sql\n"})}),"\n",(0,r.jsx)(n.p,{children:"The following results should be returned:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-json",children:'[\n    {\n        "page": "Copa Am\xe9rica Centenario",\n        "Edits": 29\n    },\n    {\n        "page": "User:Cyde/List of candidates for speedy deletion/Subpage",\n        "Edits": 16\n    },\n    {\n        "page": "Wikipedia:Administrators\' noticeboard/Incidents",\n        "Edits": 16\n    },\n    {\n        "page": "2016 Wimbledon Championships \u2013 Men\'s Singles",\n        "Edits": 15\n    },\n    {\n        "page": "Wikipedia:Administrator intervention against vandalism",\n        "Edits": 15\n    },\n    {\n        "page": "Wikipedia:Vandalismusmeldung",\n        "Edits": 15\n    },\n    {\n        "page": "The Winds of Winter (Game of Thrones)",\n        "Edits": 12\n    },\n    {\n        "page": "\u0648\u0644\u0627\u064a\u0629 \u0627\u0644\u062c\u0632\u0627\u0626\u0631",\n        "Edits": 12\n    },\n    {\n        "page": "Copa Am\xe9rica",\n        "Edits": 10\n    },\n    {\n        "page": "Lionel Messi",\n        "Edits": 10\n    }\n]\n'})}),"\n",(0,r.jsx)(n.h2,{id:"further-reading",children:"Further reading"}),"\n",(0,r.jsxs)(n.p,{children:["See the ",(0,r.jsx)(n.a,{href:"/docs/33.0.0/querying/sql",children:"Druid SQL documentation"})," for more information on using Druid SQL queries."]}),"\n",(0,r.jsxs)(n.p,{children:["See the ",(0,r.jsx)(n.a,{href:"/docs/33.0.0/querying/",children:"Queries documentation"})," for more information on Druid native queries."]})]})}function c(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(u,{...e})}):u(e)}},57053:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/tutorial-query-01-255bc08f1f43198a74d6e0b51ba63b34.png"},72016:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/tutorial-query-04-5762722de0e9501228916e5a9939f4af.png"},75846:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/tutorial-query-02-ba5ead6e542013d5312417a810009ef7.png"},78265:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/tutorial-query-05-5231df83d786973ce7a18851f434b534.png"},85835:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/tutorial-query-07-86073da8ac47313ee65b520bcf7b5984.png"},95330:(e,n,i)=>{i.d(n,{A:()=>t});const t=i.p+"assets/images/tutorial-query-06-38a4873c0c5bd253039663d3feab2e65.png"}}]);