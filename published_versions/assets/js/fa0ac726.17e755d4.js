"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3029],{3905:(t,e,n)=>{n.d(e,{Zo:()=>p,kt:()=>y});var a=n(67294);function r(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function l(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?l(Object(n),!0).forEach((function(e){r(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function o(t,e){if(null==t)return{};var n,a,r=function(t,e){if(null==t)return{};var n,a,r={},l=Object.keys(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||(r[n]=t[n]);return r}(t,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(t);for(a=0;a<l.length;a++)n=l[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(r[n]=t[n])}return r}var u=a.createContext({}),d=function(t){var e=a.useContext(u),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},p=function(t){var e=d(t.components);return a.createElement(u.Provider,{value:e},t.children)},s="mdxType",m={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},k=a.forwardRef((function(t,e){var n=t.components,r=t.mdxType,l=t.originalType,u=t.parentName,p=o(t,["components","mdxType","originalType","parentName"]),s=d(n),k=r,y=s["".concat(u,".").concat(k)]||s[k]||m[k]||l;return n?a.createElement(y,i(i({ref:e},p),{},{components:n})):a.createElement(y,i({ref:e},p))}));function y(t,e){var n=arguments,r=e&&e.mdxType;if("string"==typeof t||r){var l=n.length,i=new Array(l);i[0]=k;var o={};for(var u in e)hasOwnProperty.call(e,u)&&(o[u]=e[u]);o.originalType=t,o[s]="string"==typeof t?t:r,i[1]=o;for(var d=2;d<l;d++)i[d]=n[d];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},46398:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>p,contentTitle:()=>u,default:()=>y,frontMatter:()=>o,metadata:()=>d,toc:()=>s});var a=n(87462),r=n(63366),l=(n(67294),n(3905)),i=["components"],o={id:"tutorial-latest-by",title:"Query for latest values",sidebar_label:"Query for latest data",description:"How to use LATEST_BY or deltas for up-to-date values."},u=void 0,d={unversionedId:"tutorials/tutorial-latest-by",id:"tutorials/tutorial-latest-by",title:"Query for latest values",description:"How to use LATEST_BY or deltas for up-to-date values.",source:"@site/docs/30.0.0/tutorials/tutorial-latest-by.md",sourceDirName:"tutorials",slug:"/tutorials/tutorial-latest-by",permalink:"/docs/30.0.0/tutorials/tutorial-latest-by",draft:!1,tags:[],version:"current",frontMatter:{id:"tutorial-latest-by",title:"Query for latest values",sidebar_label:"Query for latest data",description:"How to use LATEST_BY or deltas for up-to-date values."},sidebar:"docs",previous:{title:"Deleting data",permalink:"/docs/30.0.0/tutorials/tutorial-delete-data"},next:{title:"Query data",permalink:"/docs/30.0.0/tutorials/tutorial-query"}},p={},s=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Use LATEST_BY to retrieve updated values",id:"use-latest_by-to-retrieve-updated-values",level:2},{value:"Use delta values and aggregation for updated values",id:"use-delta-values-and-aggregation-for-updated-values",level:2},{value:"Learn more",id:"learn-more",level:2}],m={toc:s},k="wrapper";function y(t){var e=t.components,n=(0,r.Z)(t,i);return(0,l.kt)(k,(0,a.Z)({},m,n,{components:e,mdxType:"MDXLayout"}),(0,l.kt)("p",null,'This tutorial describes strategies in Apache Druid for use cases that might be handled by UPSERT in other databases. You can use the LATEST_BY aggregation at query time or "deltas" for numeric dimensions at insert time.'),(0,l.kt)("p",null,"The ",(0,l.kt)("a",{parentName:"p",href:"/docs/30.0.0/tutorials/tutorial-update-data"},"Update data")," tutorial demonstrates how to use batch operations to update data according to the timestamp, including UPSERT cases. However, with streaming data, you can potentially use LATEST_BY or deltas to satisfy requirements otherwise handled with updates."),(0,l.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,l.kt)("p",null,"Before you follow the steps in this tutorial, download Druid as described in the ",(0,l.kt)("a",{parentName:"p",href:"/docs/30.0.0/tutorials/"},"Local quickstart")," and have it running on your local machine. You don't need to load any data into the Druid cluster."),(0,l.kt)("p",null,"You should be familiar with data querying in Druid. If you haven't already, go through the ",(0,l.kt)("a",{parentName:"p",href:"/docs/30.0.0/tutorials/tutorial-query"},"Query data")," tutorial first."),(0,l.kt)("h2",{id:"use-latest_by-to-retrieve-updated-values"},"Use LATEST_BY to retrieve updated values"),(0,l.kt)("p",null,"Sometimes, you want to read the latest value of one dimension or measure in relation to another dimension. In a transactional database, you might maintain dimensions or measures using UPSERT, but in Druid you can append all updates or changes during ingestion. The LATEST_BY function lets you get the most recent value for the dimension with the following type of query:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT dimension,\n       LATEST_BY(changed_dimension, updated_timestamp)\nFROM my_table\nGROUP BY 1\n")),(0,l.kt)("p",null,"In this example ",(0,l.kt)("inlineCode",{parentName:"p"},"update_timestamp"),' represents the reference timestamp to use to evaluate the "latest" value. This could be ',(0,l.kt)("inlineCode",{parentName:"p"},"__time")," or another timestamp."),(0,l.kt)("p",null,"For example, consider the following table of events that log the total number of points for a user:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"__time")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"user_id")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"points")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"10")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:05:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"30")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"35")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"30")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:05:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"55")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T03:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"40")))),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Insert sample data"),(0,l.kt)("p",null,"In the Druid web console, navigate to the ",(0,l.kt)("strong",{parentName:"p"},"Query")," view and run the following query to insert sample data:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},'REPLACE INTO "latest_by_tutorial1" OVERWRITE ALL\nWITH "ext" AS (\n  SELECT *\n  FROM TABLE(\n    EXTERN(\n     \'{"type":"inline","data":"{\\"timestamp\\":\\"2024-01-01T01:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":10}\\n{\\"timestamp\\":\\"2024-01-01T01:05:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":30}\\n{\\"timestamp\\": \\"2024-01-01T02:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":35}\\n{\\"timestamp\\":\\"2024-01-01T02:00:00Z\\",\\"user_id\\":\\"silly_monkey2\\", \\"points\\":30}\\n{\\"timestamp\\":\\"2024-01-01T02:05:00Z\\",\\"user_id\\":\\"silly_monkey2\\", \\"points\\":55}\\n{\\"timestamp\\":\\"2024-01-01T03:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":40}"}\',\n     \'{"type":"json"}\'\n    )\n  ) EXTEND ("timestamp" VARCHAR, "user_id" VARCHAR, "points" BIGINT)\n)\nSELECT\n  TIME_PARSE("timestamp") AS "__time",\n  "user_id",\n  "points"\nFROM "ext"\nPARTITIONED BY DAY\n'))),(0,l.kt)("p",null,"Run the following query to retrieve the most recent ",(0,l.kt)("inlineCode",{parentName:"p"},"points")," value for each ",(0,l.kt)("inlineCode",{parentName:"p"},"user_id"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT user_id,\n     LATEST_BY("points", "__time") AS latest_points\nFROM latest_by_tutorial1\nGROUP BY 1\n')),(0,l.kt)("p",null,"The results are as follows:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"user_id")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"total_points")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"55")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"40")))),(0,l.kt)("p",null,"In the example, the values increase each time, but this method works even if the values fluctuate."),(0,l.kt)("p",null,"You can use this query shape as a subquery for additional processing. However, if there are many values for ",(0,l.kt)("inlineCode",{parentName:"p"},"user_id"),", the query can be expensive."),(0,l.kt)("p",null,"If you want to track the latest value at different times within a larger granularity time frame, you need an additional timestamp to record update times. This allows Druid to track the latest version. Consider the following data that represents points for various users updated within an hour time frame. ",(0,l.kt)("inlineCode",{parentName:"p"},"__time")," is hour granularity, but ",(0,l.kt)("inlineCode",{parentName:"p"},"updated_timestamp")," is minute granularity:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"__time")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"updated_timestamp")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"user_id")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"points")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"10")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:05:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"30")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"35")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"30")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:05:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"55")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T03:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T03:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"40")))),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Insert sample data"),(0,l.kt)("p",null,"Open a new tab in the ",(0,l.kt)("strong",{parentName:"p"},"Query")," view and run the following query to insert sample data:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},'REPLACE INTO "latest_by_tutorial2" OVERWRITE ALL\nWITH "ext" AS (\n  SELECT *\n  FROM TABLE(\n    EXTERN(\n     \'{"type":"inline","data":"{\\"timestamp\\":\\"2024-01-01T01:00:00Z\\",\\"updated_timestamp\\":\\"2024-01-01T01:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":10}\\n{\\"timestamp\\":\\"2024-01-01T01:05:00Z\\",\\"updated_timestamp\\":\\"2024-01-01T01:05:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":30}\\n{\\"timestamp\\": \\"2024-01-01T02:00:00Z\\",\\"updated_timestamp\\":\\"2024-01-01T02:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":35}\\n{\\"timestamp\\":\\"2024-01-01T02:00:00Z\\",\\"updated_timestamp\\":\\"2024-01-01T02:00:00Z\\",\\"user_id\\":\\"silly_monkey2\\", \\"points\\":30}\\n{\\"timestamp\\":\\"2024-01-01T02:00:00Z\\",\\"updated_timestamp\\":\\"2024-01-01T02:05:00Z\\",\\"user_id\\":\\"silly_monkey2\\", \\"points\\":55}\\n{\\"timestamp\\":\\"2024-01-01T03:00:00Z\\",\\"updated_timestamp\\":\\"2024-01-01T03:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":40}"}\',\n     \'{"type":"json"}\'\n    )\n  ) EXTEND ("timestamp" VARCHAR, "updated_timestamp" VARCHAR, "user_id" VARCHAR, "points" BIGINT)\n)\nSELECT\n  TIME_PARSE("timestamp") AS "__time",\n  "updated_timestamp",\n  "user_id",\n  "points"\nFROM "ext"\nPARTITIONED BY DAY\n'))),(0,l.kt)("p",null,"Run the following query to retrieve the latest points value by user for each hour:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT FLOOR("__time" TO HOUR) AS "hour_time",\n      "user_id",\n       LATEST_BY("points", TIME_PARSE(updated_timestamp)) AS "latest_points_hour"\nFROM latest_by_tutorial2\nGROUP BY 1,2\n')),(0,l.kt)("p",null,"The results are as follows:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"hour_time")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"user_id")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"latest_points_hour")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"20")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"5")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"25")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T03:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"10")))),(0,l.kt)("p",null,"LATEST_BY is an aggregation function. While it's very efficient when there are not many update rows matching a dimension, such as ",(0,l.kt)("inlineCode",{parentName:"p"},"user_id"),", it scans all matching rows with the same dimension. For dimensions with numerous updates, such as when a user plays a game a million times, and the updates don't arrive in a timely order, Druid processes all rows matching the ",(0,l.kt)("inlineCode",{parentName:"p"},"user_id")," to find the row with the max timestamp to provide the latest data. "),(0,l.kt)("p",null,"For instance, if updates constitute 1-5 percent of your data, you'll get good query performance. If updates constitute 50 percent or more of your data, your queries will be slow."),(0,l.kt)("p",null,"To mitigate this, you can set up a periodic batch ingestion job that re-indexes modified data into a new datasource for direct querying without grouping to reduce the cost of these queries by pre-computing and storing the latest values. Note that your view of the latest data will not be up to date until the next refresh happens."),(0,l.kt)("p",null,"Alternatively, you can perform ingestion-time aggregation using LATEST_BY and append updates with streaming ingestion into a rolled up datasource. Appending into a time chunk adds new segments and does not perfectly roll up data, so rows may be partial rather than complete rollups, and you may have multiple partially rolled up rows. In this case, you still need to use the GROUP BY query for correct querying of the rolled up data source. You can tune automatic compaction to significantly reduce the number of stale rows and improve your performance."),(0,l.kt)("h2",{id:"use-delta-values-and-aggregation-for-updated-values"},"Use delta values and aggregation for updated values"),(0,l.kt)("p",null,"Instead of appending the latest total value in your events, you can log the change in value with each event and use the aggregator you usually use. This method may allow you to avoid a level of aggregation and grouping in your queries."),(0,l.kt)("p",null,"For most applications, you can send the event data directly to Druid without pre-processing. For example, when sending impression counts to Druid, don't send the total impression count since yesterday, send just the recent impression count. You can then aggregate the total in Druid during query. Druid is optimized for adding up a lot of rows, so this might be counterintuitive to people who are familiar with batching or pre-aggregating data."),(0,l.kt)("p",null,"For example, consider a datasource with a measure column ",(0,l.kt)("inlineCode",{parentName:"p"},"y")," that you aggregate with SUM, grouped by another dimension ",(0,l.kt)("inlineCode",{parentName:"p"},"x"),". If you want to update the value of ",(0,l.kt)("inlineCode",{parentName:"p"},"y")," from 3 to 2, then insert -1 for ",(0,l.kt)("inlineCode",{parentName:"p"},"y"),". This way the aggregation ",(0,l.kt)("inlineCode",{parentName:"p"},"SUM(y)")," is correct for any queries grouped by ",(0,l.kt)("inlineCode",{parentName:"p"},"x"),". This may offer a significant performance advantage but the trade off is that the aggregation has to always be a SUM."),(0,l.kt)("p",null,"In other cases, the updates to the data may already be deltas to the original, and so the data engineering required to append the updates would be simple. The same performance impact mitigation applies as in the previous example: use rollup at ingestion time combined with ongoing automatic compaction."),(0,l.kt)("p",null,"For example, consider the following table of events that logs the number of points gained or lost for a user during a period of time:"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"__time")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"user_id")),(0,l.kt)("th",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"th"},"delta")))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"10")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T01:05:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"10")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"5")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"30")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T02:05:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"silly_monkey2")),(0,l.kt)("td",{parentName:"tr",align:null},"-5")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"2024-01-01T03:00:00.000Z")),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"funny_bunny1")),(0,l.kt)("td",{parentName:"tr",align:null},"10")))),(0,l.kt)("details",null,(0,l.kt)("summary",null,"Insert sample data"),(0,l.kt)("p",null,"Open a new tab in the ",(0,l.kt)("strong",{parentName:"p"},"Query")," view and run the following query to insert sample data:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},'REPLACE INTO "delta_tutorial" OVERWRITE ALL\nWITH "ext" AS (\n  SELECT *\n  FROM TABLE(\n    EXTERN(\n     \'{"type":"inline","data":"{\\"timestamp\\":\\"2024-01-01T01:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":10}\\n{\\"timestamp\\":\\"2024-01-01T01:05:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":10}\\n{\\"timestamp\\": \\"2024-01-01T02:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":5}\\n{\\"timestamp\\":\\"2024-01-01T02:00:00Z\\",\\"user_id\\":\\"silly_monkey2\\", \\"points\\":30}\\n{\\"timestamp\\":\\"2024-01-01T02:05:00Z\\",\\"user_id\\":\\"silly_monkey2\\", \\"points\\":-5}\\n{\\"timestamp\\":\\"2024-01-01T03:00:00Z\\",\\"user_id\\":\\"funny_bunny1\\", \\"points\\":10}"}\',\n     \'{"type":"json"}\'\n    )\n  ) EXTEND ("timestamp" VARCHAR, "user_id" VARCHAR, "points" BIGINT)\n)\nSELECT\n  TIME_PARSE("timestamp") AS "__time",\n  "user_id",\n  "points" AS "delta"\nFROM "ext"\nPARTITIONED BY DAY\n'))),(0,l.kt)("p",null,"The following query returns the same points per hour as the second LATEST_BY example:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT FLOOR("__time" TO HOUR) as "hour_time",\n       "user_id",\n       SUM("delta") AS "latest_points_hour"\nFROM "delta_tutorial"\nGROUP BY 1,2\n')),(0,l.kt)("h2",{id:"learn-more"},"Learn more"),(0,l.kt)("p",null,"See the following topics for more information:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"/docs/30.0.0/tutorials/tutorial-update-data"},"Update data")," for a tutorial on updating data in Druid."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"/docs/30.0.0/data-management/update"},"Data updates")," for an overview of updating data in Druid.")))}y.isMDXComponent=!0}}]);