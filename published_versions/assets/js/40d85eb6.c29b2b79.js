"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[289],{28453:(e,t,r)=>{r.d(t,{R:()=>d,x:()=>o});var s=r(96540);const i={},n=s.createContext(i);function d(e){const t=s.useContext(n);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),s.createElement(n.Provider,{value:t},e.children)}},61096:(e,t,r)=>{r.r(t),r.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>l,frontMatter:()=>d,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"development/extensions-contrib/prometheus","title":"Prometheus Emitter","description":"\x3c!--","source":"@site/docs/32.0.0/development/extensions-contrib/prometheus.md","sourceDirName":"development/extensions-contrib","slug":"/development/extensions-contrib/prometheus","permalink":"/docs/32.0.0/development/extensions-contrib/prometheus","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"prometheus","title":"Prometheus Emitter"}}');var i=r(74848),n=r(28453);const d={id:"prometheus",title:"Prometheus Emitter"},o=void 0,c={},a=[{value:"Introduction",id:"introduction",level:2},{value:"Configuration",id:"configuration",level:2},{value:"Ports for colocated Druid processes",id:"ports-for-colocated-druid-processes",level:3},{value:"Override properties for Peon Tasks",id:"override-properties-for-peon-tasks",level:3},{value:"Metric names",id:"metric-names",level:3},{value:"Metric mapping",id:"metric-mapping",level:3}];function h(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,n.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["To use this Apache Druid extension, ",(0,i.jsx)(t.a,{href:"/docs/32.0.0/configuration/extensions#loading-extensions",children:"include"})," ",(0,i.jsx)(t.code,{children:"prometheus-emitter"})," in the extensions load list."]}),"\n",(0,i.jsx)(t.h2,{id:"introduction",children:"Introduction"}),"\n",(0,i.jsxs)(t.p,{children:["This extension exposes ",(0,i.jsx)(t.a,{href:"https://druid.apache.org/docs/latest/operations/metrics.html",children:"Druid metrics"})," for collection by a Prometheus server (",(0,i.jsx)(t.a,{href:"https://prometheus.io/",children:"https://prometheus.io/"}),")."]}),"\n",(0,i.jsxs)(t.p,{children:["Emitter is enabled by setting ",(0,i.jsx)(t.code,{children:"druid.emitter=prometheus"})," ",(0,i.jsx)(t.a,{href:"https://druid.apache.org/docs/latest/configuration/index.html#enabling-metrics",children:"configs"})," or include ",(0,i.jsx)(t.code,{children:"prometheus"})," in the composing emitter list."]}),"\n",(0,i.jsx)(t.h2,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsxs)(t.p,{children:["All the configuration parameters for the Prometheus emitter are under ",(0,i.jsx)(t.code,{children:"druid.emitter.prometheus"}),"."]}),"\n",(0,i.jsxs)(t.table,{children:[(0,i.jsx)(t.thead,{children:(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.th,{children:"property"}),(0,i.jsx)(t.th,{children:"description"}),(0,i.jsx)(t.th,{children:"required?"}),(0,i.jsx)(t.th,{children:"default"})]})}),(0,i.jsxs)(t.tbody,{children:[(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.strategy"})}),(0,i.jsxs)(t.td,{children:["The strategy to expose prometheus metrics. ",(0,i.jsx)("br",{}),"Should be one of ",(0,i.jsx)(t.code,{children:"exporter"})," and ",(0,i.jsx)(t.code,{children:"pushgateway"}),". Default strategy ",(0,i.jsx)(t.code,{children:"exporter"})," would expose metrics for scraping purpose. Peon tasks (short-lived jobs) should use ",(0,i.jsx)(t.code,{children:"pushgateway"})," strategy."]}),(0,i.jsx)(t.td,{children:"yes"}),(0,i.jsx)(t.td,{children:"exporter"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.port"})}),(0,i.jsxs)(t.td,{children:["The port on which to expose the prometheus HTTPServer. Required if using ",(0,i.jsx)(t.code,{children:"exporter"})," strategy."]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"none"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.namespace"})}),(0,i.jsxs)(t.td,{children:["Optional metric namespace. Must match the regex ",(0,i.jsx)(t.code,{children:"[a-zA-Z_:][a-zA-Z0-9_:]*"})]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"druid"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.dimensionMapPath"})}),(0,i.jsx)(t.td,{children:"JSON file defining the Prometheus metric type, desired dimensions, help text, and conversionFactor for every Druid metric."}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"Default mapping provided. See below."})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.addHostAsLabel"})}),(0,i.jsx)(t.td,{children:"Flag to include the hostname as a prometheus label."}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"false"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.addServiceAsLabel"})}),(0,i.jsxs)(t.td,{children:["Flag to include the druid service name (e.g. ",(0,i.jsx)(t.code,{children:"druid/broker"}),", ",(0,i.jsx)(t.code,{children:"druid/coordinator"}),", etc.) as a prometheus label."]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"false"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.pushGatewayAddress"})}),(0,i.jsxs)(t.td,{children:["Pushgateway address. Required if using ",(0,i.jsx)(t.code,{children:"pushgateway"})," strategy."]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"none"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.flushPeriod"})}),(0,i.jsxs)(t.td,{children:["Emit metrics to Pushgateway every ",(0,i.jsx)(t.code,{children:"flushPeriod"})," seconds. Required if ",(0,i.jsx)(t.code,{children:"pushgateway"})," strategy is used."]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"15"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.extraLabels"})}),(0,i.jsxs)(t.td,{children:["JSON key-value pairs for additional labels on all metrics. Keys (label names) must match the regex ",(0,i.jsx)(t.code,{children:"[a-zA-Z_:][a-zA-Z0-9_:]*"}),". Example: ",(0,i.jsx)(t.code,{children:'{"cluster_name": "druid_cluster1", "env": "staging"}'}),"."]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"none"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.deletePushGatewayMetricsOnShutdown"})}),(0,i.jsxs)(t.td,{children:["Flag to delete metrics from Pushgateway on task shutdown. Works only if ",(0,i.jsx)(t.code,{children:"pushgateway"})," strategy is used. This feature allows to delete a stale metrics from batch executed tasks. Otherwise, the Pushgateway will store these stale metrics indefinitely as there is ",(0,i.jsx)(t.a,{href:"https://github.com/prometheus/pushgateway/issues/117",children:"no time to live mechanism"}),", using the memory to hold data that was already scraped by Prometheus."]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"false"})]}),(0,i.jsxs)(t.tr,{children:[(0,i.jsx)(t.td,{children:(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.waitForShutdownDelay"})}),(0,i.jsxs)(t.td,{children:["Time in milliseconds to wait for peon tasks to delete metrics from the Pushgateway on shutdown (e.g. 60_000). Applicable only when ",(0,i.jsx)(t.code,{children:"pushgateway"})," strategy is used and ",(0,i.jsx)(t.code,{children:"deletePushGatewayMetricsOnShutdown"})," is set to true. There is no guarantee that a peon task will delete metrics from the gateway if the configured delay is more than the ",(0,i.jsxs)(t.a,{href:"https://druid.apache.org/docs/latest/configuration/#additional-peon-configuration",children:["Peon's ",(0,i.jsx)(t.code,{children:"druid.indexer.task.gracefulShutdownTimeout"})]})," value. For best results, set this value is 1.2 times the configured Prometheus ",(0,i.jsx)(t.code,{children:"scrape_interval"})," of Pushgateway to ensure that  Druid scrapes the metrics before cleanup."]}),(0,i.jsx)(t.td,{children:"no"}),(0,i.jsx)(t.td,{children:"none"})]})]})]}),"\n",(0,i.jsx)(t.h3,{id:"ports-for-colocated-druid-processes",children:"Ports for colocated Druid processes"}),"\n",(0,i.jsxs)(t.p,{children:["In certain instances, Druid processes may be colocated on the same host. For example, the Broker and Router may share the same server. Other colocated processes include the Historical and Middle Manager or the Coordinator and Overlord. When you have colocated processes, specify ",(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.port"})," separately for each process on each host. For example, even if the Broker and Router share the same host, the Broker runtime properties and the Router runtime properties each need to list ",(0,i.jsx)(t.code,{children:"druid.emitter.prometheus.port"}),", and the port value for both must be different."]}),"\n",(0,i.jsx)(t.h3,{id:"override-properties-for-peon-tasks",children:"Override properties for Peon Tasks"}),"\n",(0,i.jsxs)(t.p,{children:["Peon tasks are created dynamically by middle managers and have dynamic host and port addresses. Since the ",(0,i.jsx)(t.code,{children:"exporter"})," strategy allows Prometheus to read only from a fixed address, it cannot be used for peon tasks.\nSo, these tasks need to be configured to use ",(0,i.jsx)(t.code,{children:"pushgateway"})," strategy to push metrics from Druid to prometheus gateway."]}),"\n",(0,i.jsxs)(t.p,{children:["If this emitter is configured to use ",(0,i.jsx)(t.code,{children:"exporter"})," strategy globally, some of the above configurations need to be overridden in the middle manager so that spawned peon tasks can still use the ",(0,i.jsx)(t.code,{children:"pushgateway"})," strategy."]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"#\n# Override global prometheus emitter configuration for peon tasks to use `pushgateway` strategy.\n# Other configurations can also be overridden by adding `druid.indexer.fork.property.` prefix to above configuration properties.\n# \ndruid.indexer.fork.property.druid.emitter.prometheus.strategy=pushgateway\ndruid.indexer.fork.property.druid.emitter.prometheus.pushGatewayAddress=http://<push-gateway-address>\n"})}),"\n",(0,i.jsx)(t.h3,{id:"metric-names",children:"Metric names"}),"\n",(0,i.jsx)(t.p,{children:"All metric names and labels are reformatted to match Prometheus standards."}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["For names: all characters which are not alphanumeric, underscores, or colons (matching ",(0,i.jsx)(t.code,{children:"[^a-zA-Z_:][^a-zA-Z0-9_:]*"}),") are replaced with ",(0,i.jsx)(t.code,{children:"_"})]}),"\n",(0,i.jsxs)(t.li,{children:["For labels: all characters which are not alphanumeric or underscores (matching ",(0,i.jsx)(t.code,{children:"[^a-zA-Z0-9_][^a-zA-Z0-9_]*"}),") are replaced with ",(0,i.jsx)(t.code,{children:"_"})]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"metric-mapping",children:"Metric mapping"}),"\n",(0,i.jsxs)(t.p,{children:["Each metric to be collected by Prometheus must specify a type, one of ",(0,i.jsx)(t.code,{children:"[timer, counter, guage]"}),". Prometheus Emitter expects this mapping to\nbe provided as a JSON file.  Additionally, this mapping specifies which dimensions should be included for each metric.  Prometheus expects\nhistogram timers to use Seconds as the base unit.  Timers which do not use seconds as a base unit can use the ",(0,i.jsx)(t.code,{children:"conversionFactor"})," to set\nthe base time unit. If the user does not specify their own JSON file, a default mapping is used.  All\nmetrics are expected to be mapped. Metrics which are not mapped will not be tracked."]}),"\n",(0,i.jsx)(t.p,{children:"Prometheus metric path is organized using the following schema:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'<druid metric name> : { \n  "dimensions" : <dimension list>, \n  "type" : <timer|counter|gauge>, \n  "conversionFactor": <conversionFactor>, \n  "help" : <help text>\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"For example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'"query/time" : { \n  "dimensions" : ["dataSource", "type"],\n  "type" : "timer",\n  "conversionFactor": 1000.0,\n  "help": "Seconds taken to complete a query."\n}\n'})}),"\n",(0,i.jsx)(t.p,{children:"For metrics which are emitted from multiple services with different dimensions, the metric name is prefixed with\nthe service name. For example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-json",children:'"druid/coordinator-segment/count" : { "dimensions" : ["dataSource"], "type" : "gauge" },\n"druid/historical-segment/count" : { "dimensions" : ["dataSource", "tier", "priority"], "type" : "gauge" }\n'})}),"\n",(0,i.jsx)(t.p,{children:"For most use cases, the default mapping is sufficient."})]})}function l(e={}){const{wrapper:t}={...(0,n.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}}}]);