"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2819],{20917:(e,r,t)=>{t.r(r),t.d(r,{assets:()=>l,contentTitle:()=>i,default:()=>c,frontMatter:()=>n,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"operations/durable-storage","title":"Durable storage for the multi-stage query engine","description":"\x3c!--","source":"@site/docs/32.0.0/operations/durable-storage.md","sourceDirName":"operations","slug":"/operations/durable-storage","permalink":"/docs/32.0.0/operations/durable-storage","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"durable-storage","title":"Durable storage for the multi-stage query engine","sidebar_label":"Durable storage"},"sidebar":"docs","previous":{"title":"Java runtime","permalink":"/docs/32.0.0/operations/java"},"next":{"title":"Security overview","permalink":"/docs/32.0.0/operations/security-overview"}}');var o=t(74848),a=t(28453);const n={id:"durable-storage",title:"Durable storage for the multi-stage query engine",sidebar_label:"Durable storage"},i=void 0,l={},d=[{value:"Enable durable storage",id:"enable-durable-storage",level:2},{value:"Use durable storage for SQL-based ingestion queries",id:"use-durable-storage-for-sql-based-ingestion-queries",level:2},{value:"Use durable storage for queries from deep storage",id:"use-durable-storage-for-queries-from-deep-storage",level:2},{value:"Durable storage clean up",id:"durable-storage-clean-up",level:2}];function u(e){const r={a:"a",blockquote:"blockquote",code:"code",h2:"h2",p:"p",pre:"pre",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.p,{children:"You can use durable storage to improve querying from deep storage and SQL-based ingestion."}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsx)(r.p,{children:"Note that S3, Azure and Google are all supported as durable storage locations."}),"\n"]}),"\n",(0,o.jsx)(r.p,{children:"Durable storage for queries from deep storage provides a location where you can write the results of deep storage queries to. Durable storage for SQL-based ingestion is used to temporarily house intermediate files, which can improve reliability."}),"\n",(0,o.jsxs)(r.p,{children:["Enabling durable storage also enables the use of local disk to store temporary files, such as the intermediate files produced\nwhile sorting the data. Tasks will use whatever has been configured for their temporary usage as described in ",(0,o.jsx)(r.a,{href:"/docs/32.0.0/ingestion/tasks#configuring-task-storage-sizes",children:"Configuring task storage sizes"}),".\nIf the configured limit is too low, Druid may throw the error, ",(0,o.jsx)(r.code,{children:"NotEnoughTemporaryStorageFault"}),"."]}),"\n",(0,o.jsx)(r.h2,{id:"enable-durable-storage",children:"Enable durable storage"}),"\n",(0,o.jsx)(r.p,{children:"To enable durable storage, you need to set the following common service properties:"}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"druid.msq.intermediate.storage.enable=true\ndruid.msq.intermediate.storage.tempDir=/path/to/your/temp/dir\n\n# Include these configs if you're using S3\n# druid.msq.intermediate.storage.type=s3\n# druid.msq.intermediate.storage.bucket=YOUR_BUCKET\n\n# Include these configs if you're using Azure Blob Storage\n# druid.msq.intermediate.storage.type=azure\n# druid.sq.intermediate.storage.container=YOUR_CONTAINER\n\ndruid.msq.intermediate.storage.prefix=YOUR_PREFIX\n"})}),"\n",(0,o.jsxs)(r.p,{children:["For detailed information about these and additional settings related to durable storage, see ",(0,o.jsx)(r.a,{href:"/docs/32.0.0/multi-stage-query/reference#durable-storage-configurations",children:"Durable storage configurations"}),"."]}),"\n",(0,o.jsx)(r.h2,{id:"use-durable-storage-for-sql-based-ingestion-queries",children:"Use durable storage for SQL-based ingestion queries"}),"\n",(0,o.jsxs)(r.p,{children:["When you run a query, include the context parameter ",(0,o.jsx)(r.code,{children:"durableShuffleStorage"})," and set it to ",(0,o.jsx)(r.code,{children:"true"}),"."]}),"\n",(0,o.jsxs)(r.p,{children:["For queries where you want to use fault tolerance for workers,  set ",(0,o.jsx)(r.code,{children:"faultTolerance"})," to ",(0,o.jsx)(r.code,{children:"true"}),", which automatically sets ",(0,o.jsx)(r.code,{children:"durableShuffleStorage"})," to ",(0,o.jsx)(r.code,{children:"true"}),"."]}),"\n",(0,o.jsx)(r.h2,{id:"use-durable-storage-for-queries-from-deep-storage",children:"Use durable storage for queries from deep storage"}),"\n",(0,o.jsx)(r.p,{children:"Depending on the size of the results you're expecting, saving the final results for queries from deep storage to durable storage might be needed."}),"\n",(0,o.jsx)(r.p,{children:"By default, Druid saves the final results for queries from deep storage to task reports. Generally, this is acceptable for smaller result sets but may lead to timeouts for larger result sets."}),"\n",(0,o.jsxs)(r.p,{children:["When you run a query, include the context parameter ",(0,o.jsx)(r.code,{children:"selectDestination"})," and set it to ",(0,o.jsx)(r.code,{children:"durableStorage"}),":"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-json",children:'    "context":{\n        ...\n        "selectDestination": "durableStorage"\n    }\n'})}),"\n",(0,o.jsxs)(r.p,{children:["You can also write intermediate results to durable storage (",(0,o.jsx)(r.code,{children:"durableShuffleStorage"}),") for better reliability. The location where workers write intermediate results is different than the location where final results get stored. This means that durable storage for results can be enabled even if you don't write intermediate results to durable storage."]}),"\n",(0,o.jsx)(r.p,{children:"If you write the results for queries from deep storage to durable storage, the results are cleaned up when the task is removed from the metadata store."}),"\n",(0,o.jsx)(r.h2,{id:"durable-storage-clean-up",children:"Durable storage clean up"}),"\n",(0,o.jsx)(r.p,{children:"To prevent durable storage from getting filled up with temporary files in case the tasks fail to clean them up, a periodic\ncleaner can be scheduled to clean the directories corresponding to which there isn't a controller task running. It utilizes\nthe storage connector to work upon the durable storage. The durable storage location should only be utilized to store the output\nfor the cluster's MSQ tasks. If the location contains other files or directories, then they will get cleaned up as well."}),"\n",(0,o.jsxs)(r.p,{children:["Use ",(0,o.jsx)(r.code,{children:"druid.msq.intermediate.storage.cleaner.enabled"})," and ",(0,o.jsx)(r.code,{children:"druid.msq.intermediate.storage.cleaner.delaySeconds"})," to configure the cleaner. For more information, see ",(0,o.jsx)(r.a,{href:"/docs/32.0.0/multi-stage-query/reference#durable-storage-configurations",children:"Durable storage configurations"}),"."]}),"\n",(0,o.jsx)(r.p,{children:"Note that if you choose to write query results to durable storage,the results are cleaned up when the task is removed from the metadata store."})]})}function c(e={}){const{wrapper:r}={...(0,a.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(u,{...e})}):u(e)}},28453:(e,r,t)=>{t.d(r,{R:()=>n,x:()=>i});var s=t(96540);const o={},a=s.createContext(o);function n(e){const r=s.useContext(a);return s.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:n(e.components),s.createElement(a.Provider,{value:r},e.children)}}}]);