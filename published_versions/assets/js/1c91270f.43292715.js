"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[2782],{14415:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>n,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"operations/metadata-migration","title":"Metadata Migration","description":"\x3c!--","source":"@site/docs/33.0.0/operations/metadata-migration.md","sourceDirName":"operations","slug":"/operations/metadata-migration","permalink":"/docs/33.0.0/operations/metadata-migration","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"metadata-migration","title":"Metadata Migration"},"sidebar":"docs","previous":{"title":"Export Metadata Tool","permalink":"/docs/33.0.0/operations/export-metadata"},"next":{"title":"Content for build.sbt","permalink":"/docs/33.0.0/operations/use_sbt_to_build_fat_jar"}}');var r=a(74848),i=a(28453);const n={id:"metadata-migration",title:"Metadata Migration"},o=void 0,d={},l=[{value:"Shut down cluster services",id:"shut-down-cluster-services",level:2},{value:"Exporting metadata",id:"exporting-metadata",level:2},{value:"Initializing the new metadata store",id:"initializing-the-new-metadata-store",level:2},{value:"Create database",id:"create-database",level:3},{value:"Update configuration",id:"update-configuration",level:3},{value:"Create Druid tables",id:"create-druid-tables",level:3},{value:"MySQL",id:"mysql",level:4},{value:"PostgreSQL",id:"postgresql",level:4},{value:"Update Druid tables to latest compatible schema",id:"update-druid-tables-to-latest-compatible-schema",level:3},{value:"Import metadata",id:"import-metadata",level:3},{value:"Restart cluster",id:"restart-cluster",level:3}];function c(e){const t={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"If you have been running an evaluation Druid cluster using the built-in Derby metadata storage and wish to migrate to a\nmore production-capable metadata store such as MySQL or PostgreSQL, this document describes the necessary steps."}),"\n",(0,r.jsx)(t.h2,{id:"shut-down-cluster-services",children:"Shut down cluster services"}),"\n",(0,r.jsx)(t.p,{children:"To ensure a clean migration, shut down the non-coordinator services to ensure that metadata state will not\nchange as you do the migration."}),"\n",(0,r.jsx)(t.p,{children:"When migrating from Derby, the coordinator processes will still need to be up initially, as they host the Derby database."}),"\n",(0,r.jsx)(t.h2,{id:"exporting-metadata",children:"Exporting metadata"}),"\n",(0,r.jsxs)(t.p,{children:["Druid provides an ",(0,r.jsx)(t.a,{href:"/docs/33.0.0/operations/export-metadata",children:"Export Metadata Tool"})," for exporting metadata from Derby into CSV files\nwhich can then be imported into your new metadata store."]}),"\n",(0,r.jsxs)(t.p,{children:["The tool also provides options for rewriting the deep storage locations of segments; this is useful\nfor ",(0,r.jsx)(t.a,{href:"/docs/33.0.0/operations/deep-storage-migration",children:"deep storage migration"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Run the ",(0,r.jsx)(t.code,{children:"export-metadata"})," tool on your existing cluster, and save the CSV files it generates. After a successful export, you can shut down the coordinator."]}),"\n",(0,r.jsx)(t.h2,{id:"initializing-the-new-metadata-store",children:"Initializing the new metadata store"}),"\n",(0,r.jsx)(t.h3,{id:"create-database",children:"Create database"}),"\n",(0,r.jsx)(t.p,{children:"Before importing the existing cluster metadata, you will need to set up the new metadata store."}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.a,{href:"/docs/33.0.0/development/extensions-core/mysql",children:"MySQL extension"})," and ",(0,r.jsx)(t.a,{href:"/docs/33.0.0/development/extensions-core/postgresql",children:"PostgreSQL extension"})," docs have instructions for initial database setup."]}),"\n",(0,r.jsx)(t.h3,{id:"update-configuration",children:"Update configuration"}),"\n",(0,r.jsx)(t.p,{children:"Update your Druid runtime properties with the new metadata configuration."}),"\n",(0,r.jsx)(t.h3,{id:"create-druid-tables",children:"Create Druid tables"}),"\n",(0,r.jsx)(t.p,{children:(0,r.jsxs)(t.strong,{children:["If you have set ",(0,r.jsx)(t.code,{children:"druid.metadata.storage.connector.createTables"})," to ",(0,r.jsx)(t.code,{children:"true"})," (which is the default), and your metadata connect user has DDL privileges, you can disregard this section as Druid will create metadata tables automatically on start up."]})}),"\n",(0,r.jsxs)(t.p,{children:["Druid provides a ",(0,r.jsx)(t.code,{children:"metadata-init"})," tool for creating Druid's metadata tables. After initializing the Druid database, you can run the commands shown below from the root of the Druid package to initialize the tables."]}),"\n",(0,r.jsx)(t.p,{children:"In the example commands below:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"lib"})," is the Druid lib directory"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"extensions"})," is the Druid extensions directory"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"base"})," corresponds to the value of ",(0,r.jsx)(t.code,{children:"druid.metadata.storage.tables.base"})," in the configuration, ",(0,r.jsx)(t.code,{children:"druid"})," by default."]}),"\n",(0,r.jsxs)(t.li,{children:["The ",(0,r.jsx)(t.code,{children:"--connectURI"})," parameter corresponds to the value of ",(0,r.jsx)(t.code,{children:"druid.metadata.storage.connector.connectURI"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["The ",(0,r.jsx)(t.code,{children:"--user"})," parameter corresponds to the value of ",(0,r.jsx)(t.code,{children:"druid.metadata.storage.connector.user"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["The ",(0,r.jsx)(t.code,{children:"--password"})," parameter corresponds to the value of ",(0,r.jsx)(t.code,{children:"druid.metadata.storage.connector.password"}),"."]}),"\n"]}),"\n",(0,r.jsx)(t.h4,{id:"mysql",children:"MySQL"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:'cd ${DRUID_ROOT}\njava -classpath "lib/*" -Dlog4j.configurationFile=conf/druid/cluster/_common/log4j2.xml -Ddruid.extensions.directory="extensions" -Ddruid.extensions.loadList="[\\"mysql-metadata-storage\\"]" -Ddruid.metadata.storage.type=mysql -Ddruid.node.type=metadata-init org.apache.druid.cli.Main tools metadata-init --connectURI="<mysql-uri>" --user <user> --password <pass> --base druid\n'})}),"\n",(0,r.jsx)(t.h4,{id:"postgresql",children:"PostgreSQL"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:'cd ${DRUID_ROOT}\njava -classpath "lib/*" -Dlog4j.configurationFile=conf/druid/cluster/_common/log4j2.xml -Ddruid.extensions.directory="extensions" -Ddruid.extensions.loadList="[\\"postgresql-metadata-storage\\"]" -Ddruid.metadata.storage.type=postgresql -Ddruid.node.type=metadata-init org.apache.druid.cli.Main tools metadata-init --connectURI="<postgresql-uri>" --user <user> --password <pass> --base druid\n'})}),"\n",(0,r.jsx)(t.h3,{id:"update-druid-tables-to-latest-compatible-schema",children:"Update Druid tables to latest compatible schema"}),"\n",(0,r.jsx)(t.p,{children:"The same command as above can be used to update Druid metadata tables to the latest version. If any table already exists, it is not created again but any ALTER statements that may be required are still executed."}),"\n",(0,r.jsx)(t.h3,{id:"import-metadata",children:"Import metadata"}),"\n",(0,r.jsxs)(t.p,{children:["After initializing the tables, please refer to the ",(0,r.jsx)(t.a,{href:"/docs/33.0.0/operations/export-metadata#importing-metadata",children:"import commands"})," for your target database."]}),"\n",(0,r.jsx)(t.h3,{id:"restart-cluster",children:"Restart cluster"}),"\n",(0,r.jsx)(t.p,{children:"After importing the metadata successfully, you can now restart your cluster."})]})}function u(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},28453:(e,t,a)=>{a.d(t,{R:()=>n,x:()=>o});var s=a(96540);const r={},i=s.createContext(r);function n(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:n(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);