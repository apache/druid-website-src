"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[3596],{6792:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>i,metadata:()=>n,toc:()=>o});const n=JSON.parse('{"id":"tutorials/tutorial-rollup","title":"Aggregate data with rollup","description":"\x3c!--","source":"@site/docs/latest/tutorials/tutorial-rollup.md","sourceDirName":"tutorials","slug":"/tutorials/tutorial-rollup","permalink":"/docs/latest/tutorials/tutorial-rollup","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"tutorial-rollup","title":"Aggregate data with rollup","sidebar_label":"Aggregate data with rollup"},"sidebar":"docs","previous":{"title":"Load from Apache Kafka","permalink":"/docs/latest/tutorials/tutorial-kafka"},"next":{"title":"Write an ingestion spec","permalink":"/docs/latest/tutorials/tutorial-ingestion-spec"}}');var r=s(74848),d=s(28453);const i={id:"tutorial-rollup",title:"Aggregate data with rollup",sidebar_label:"Aggregate data with rollup"},c=void 0,l={},o=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Load the example data",id:"load-the-example-data",level:2},{value:"Query the example data",id:"query-the-example-data",level:2},{value:"View rollup in action",id:"view-rollup-in-action",level:2},{value:"Learn more",id:"learn-more",level:2}];function a(e){const t={a:"a",code:"code",h2:"h2",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(t.p,{children:['Apache Druid\xae can summarize raw data at ingestion time using a process known as "rollup." ',(0,r.jsx)(t.a,{href:"/docs/latest/multi-stage-query/concepts#rollup",children:"Rollup"})," is a first-level aggregation operation over a selected set of columns that reduces the size of stored data."]}),"\n",(0,r.jsxs)(t.p,{children:["This tutorial demonstrates how to apply rollup during ingestion and highlights its effects during query execution. The examples in the tutorial use the ",(0,r.jsx)(t.a,{href:"/docs/latest/multi-stage-query/",children:"multi-stage query (MSQ)"})," task engine to execute SQL statements."]}),"\n",(0,r.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,r.jsxs)(t.p,{children:["Before proceeding, download Druid as described in ",(0,r.jsx)(t.a,{href:"/docs/latest/tutorials/",children:"Quickstart (local)"})," and have it running on your local machine. You don't need to load any data into the Druid cluster."]}),"\n",(0,r.jsxs)(t.p,{children:["You should be familiar with data querying in Druid. If you haven't already, go through the ",(0,r.jsx)(t.a,{href:"/docs/latest/tutorials/tutorial-query",children:"Query data"})," tutorial first."]}),"\n",(0,r.jsx)(t.h2,{id:"load-the-example-data",children:"Load the example data"}),"\n",(0,r.jsx)(t.p,{children:"For this tutorial, you use a small sample of network flow event data representing IP traffic.\nThe data contains packet and byte counts from a source IP address to a destination IP address."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{"timestamp":"2018-01-01T01:01:35Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":20,"bytes":9024}\n{"timestamp":"2018-01-01T01:01:51Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":255,"bytes":21133}\n{"timestamp":"2018-01-01T01:01:59Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":11,"bytes":5780}\n{"timestamp":"2018-01-01T01:02:14Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":38,"bytes":6289}\n{"timestamp":"2018-01-01T01:02:29Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":377,"bytes":359971}\n{"timestamp":"2018-01-01T01:03:29Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":49,"bytes":10204}\n{"timestamp":"2018-01-02T21:33:14Z","srcIP":"7.7.7.7", "dstIP":"8.8.8.8","packets":38,"bytes":6289}\n{"timestamp":"2018-01-02T21:33:45Z","srcIP":"7.7.7.7", "dstIP":"8.8.8.8","packets":123,"bytes":93999}\n{"timestamp":"2018-01-02T21:35:45Z","srcIP":"7.7.7.7", "dstIP":"8.8.8.8","packets":12,"bytes":2818}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Load the sample dataset using the ",(0,r.jsx)(t.a,{href:"/docs/latest/multi-stage-query/reference#insert",children:(0,r.jsx)(t.code,{children:"INSERT INTO"})})," statement and the ",(0,r.jsx)(t.a,{href:"/docs/latest/multi-stage-query/reference#extern-function",children:(0,r.jsx)(t.code,{children:"EXTERN"})})," function to ingest the data inline. In the ",(0,r.jsx)(t.a,{href:"/docs/latest/operations/web-console",children:"Druid web console"}),", go to the ",(0,r.jsx)(t.strong,{children:"Query"})," view and run the following query:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sql",children:'INSERT INTO "rollup_tutorial"\nWITH "inline_data" AS (\n  SELECT *\n  FROM TABLE(EXTERN(\'{\n    "type":"inline",\n    "data":"{\\"timestamp\\":\\"2018-01-01T01:01:35Z\\",\\"srcIP\\":\\"1.1.1.1\\",\\"dstIP\\":\\"2.2.2.2\\",\\"packets\\":20,\\"bytes\\":9024}\\n{\\"timestamp\\":\\"2018-01-01T01:02:14Z\\",\\"srcIP\\":\\"1.1.1.1\\",\\"dstIP\\":\\"2.2.2.2\\",\\"packets\\":38,\\"bytes\\":6289}\\n{\\"timestamp\\":\\"2018-01-01T01:01:59Z\\",\\"srcIP\\":\\"1.1.1.1\\",\\"dstIP\\":\\"2.2.2.2\\",\\"packets\\":11,\\"bytes\\":5780}\\n{\\"timestamp\\":\\"2018-01-01T01:01:51Z\\",\\"srcIP\\":\\"1.1.1.1\\",\\"dstIP\\":\\"2.2.2.2\\",\\"packets\\":255,\\"bytes\\":21133}\\n{\\"timestamp\\":\\"2018-01-01T01:02:29Z\\",\\"srcIP\\":\\"1.1.1.1\\",\\"dstIP\\":\\"2.2.2.2\\",\\"packets\\":377,\\"bytes\\":359971}\\n{\\"timestamp\\":\\"2018-01-01T01:03:29Z\\",\\"srcIP\\":\\"1.1.1.1\\",\\"dstIP\\":\\"2.2.2.2\\",\\"packets\\":49,\\"bytes\\":10204}\\n{\\"timestamp\\":\\"2018-01-02T21:33:14Z\\",\\"srcIP\\":\\"7.7.7.7\\",\\"dstIP\\":\\"8.8.8.8\\",\\"packets\\":38,\\"bytes\\":6289}\\n{\\"timestamp\\":\\"2018-01-02T21:33:45Z\\",\\"srcIP\\":\\"7.7.7.7\\",\\"dstIP\\":\\"8.8.8.8\\",\\"packets\\":123,\\"bytes\\":93999}\\n{\\"timestamp\\":\\"2018-01-02T21:35:45Z\\",\\"srcIP\\":\\"7.7.7.7\\",\\"dstIP\\":\\"8.8.8.8\\",\\"packets\\":12,\\"bytes\\":2818}"}\', \n    \'{"type":"json"}\')) \n    EXTEND ("timestamp" VARCHAR, "srcIP" VARCHAR, "dstIP" VARCHAR, "packets" BIGINT, "bytes" BIGINT)\n)\nSELECT\n  FLOOR(TIME_PARSE("timestamp") TO MINUTE) AS __time,\n  "srcIP",\n  "dstIP",\n  SUM("bytes") AS "bytes",\n  SUM("packets") AS "packets",\n  COUNT(*) AS "count"\nFROM "inline_data"\nGROUP BY 1, 2, 3\nPARTITIONED BY DAY\n'})}),"\n",(0,r.jsx)(t.p,{children:"Note the following aspects of the ingestion statement:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["You transform the timestamp field using the ",(0,r.jsx)(t.code,{children:"FLOOR"})," function to round timestamps down to the minute."]}),"\n",(0,r.jsxs)(t.li,{children:["You group by the dimensions ",(0,r.jsx)(t.code,{children:"timestamp"}),", ",(0,r.jsx)(t.code,{children:"srcIP"}),", and ",(0,r.jsx)(t.code,{children:"dstIP"}),"."]}),"\n",(0,r.jsxs)(t.li,{children:["You create the ",(0,r.jsx)(t.code,{children:"bytes"})," and ",(0,r.jsx)(t.code,{children:"packets"})," metrics, which are summed from their respective input fields."]}),"\n",(0,r.jsxs)(t.li,{children:["You also create the ",(0,r.jsx)(t.code,{children:"count"})," metric that records the number of rows that get rolled-up per each row in the datasource."]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"With rollup, Druid combines rows with identical timestamp and dimension values after the timestamp truncation. Druid computes and stores the metric values using the specified aggregation function over each set of rolled-up rows."}),"\n",(0,r.jsx)(t.p,{children:"After the ingestion completes, you can query the data."}),"\n",(0,r.jsx)(t.h2,{id:"query-the-example-data",children:"Query the example data"}),"\n",(0,r.jsxs)(t.p,{children:["In the web console, open a new tab in the ",(0,r.jsx)(t.strong,{children:"Query"})," view. Run the following query to view the ingested data:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-sql",children:'SELECT * FROM "rollup_tutorial"\n'})}),"\n",(0,r.jsx)(t.p,{children:"Returns the following:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"__time"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"srcIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"dstIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"bytes"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"count"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"packets"})})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-01T01:01:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1.1.1.1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2.2.2.2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"35,937"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"3"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"286"})})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-01T01:02:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1.1.1.1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2.2.2.2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"366,260"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"415"})})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-01T01:03:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1.1.1.1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2.2.2.2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"10,204"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"49"})})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-02T21:33:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"7.7.7.7"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"8.8.8.8"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"100,288"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"161"})})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-02T21:35:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"7.7.7.7"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"8.8.8.8"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2,818"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"12"})})]})]})]}),"\n",(0,r.jsx)(t.p,{children:"Notice there are only five rows as opposed to the nine rows in the example data. In the next section, you explore the components of the rolled-up rows."}),"\n",(0,r.jsx)(t.h2,{id:"view-rollup-in-action",children:"View rollup in action"}),"\n",(0,r.jsxs)(t.p,{children:["Consider the three events in the original input data that occur over the course of minute ",(0,r.jsx)(t.code,{children:"2018-01-01T01:01"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{"timestamp":"2018-01-01T01:01:35Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":20,"bytes":9024}\n{"timestamp":"2018-01-01T01:01:51Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":255,"bytes":21133}\n{"timestamp":"2018-01-01T01:01:59Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":11,"bytes":5780}\n'})}),"\n",(0,r.jsx)(t.p,{children:"Druid combines the three rows into one during rollup:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"__time"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"srcIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"dstIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"bytes"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"count"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"packets"})})]})}),(0,r.jsx)(t.tbody,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-01T01:01:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1.1.1.1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2.2.2.2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"35,937"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"3"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"286"})})]})})]}),"\n",(0,r.jsxs)(t.p,{children:["Before the grouping occurs, the ",(0,r.jsx)(t.code,{children:'FLOOR(TIME_PARSE("timestamp") TO MINUTE)'})," expression buckets (floors) the timestamp column of the original input by minute."]}),"\n",(0,r.jsxs)(t.p,{children:["The input rows are grouped because they have the same values for their dimension columns ",(0,r.jsx)(t.code,{children:"{timestamp, srcIP, dstIP}"}),". The metric columns calculate the sum aggregation of the grouped rows for ",(0,r.jsx)(t.code,{children:"packets"})," and ",(0,r.jsx)(t.code,{children:"bytes"}),". The ",(0,r.jsx)(t.code,{children:"count"})," metric shows how many rows from the original input data contributed to the final rolled-up row."]}),"\n",(0,r.jsxs)(t.p,{children:["Now, consider the two events in the original input data that occur over the course of minute ",(0,r.jsx)(t.code,{children:"2018-01-01T01:02"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{"timestamp":"2018-01-01T01:02:14Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":38,"bytes":6289}\n{"timestamp":"2018-01-01T01:02:29Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":377,"bytes":359971}\n'})}),"\n",(0,r.jsx)(t.p,{children:"The rows are grouped into the following during rollup:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"__time"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"srcIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"dstIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"bytes"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"count"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"packets"})})]})}),(0,r.jsx)(t.tbody,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-01T01:02:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1.1.1.1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2.2.2.2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"366,260"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"415"})})]})})]}),"\n",(0,r.jsxs)(t.p,{children:["In the original input data, only one event occurs over the course of minute ",(0,r.jsx)(t.code,{children:"2018-01-01T01:03"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{"timestamp":"2018-01-01T01:03:29Z","srcIP":"1.1.1.1", "dstIP":"2.2.2.2","packets":49,"bytes":10204}\n'})}),"\n",(0,r.jsx)(t.p,{children:"Therefore, no rollup takes place:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"__time"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"srcIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"dstIP"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"bytes"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"count"})}),(0,r.jsx)(t.th,{children:(0,r.jsx)(t.code,{children:"packets"})})]})}),(0,r.jsx)(t.tbody,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2018-01-01T01:03:00.000Z"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1.1.1.1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"2.2.2.2"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"10,204"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"1"})}),(0,r.jsx)(t.td,{children:(0,r.jsx)(t.code,{children:"49"})})]})})]}),"\n",(0,r.jsx)(t.h2,{id:"learn-more",children:"Learn more"}),"\n",(0,r.jsx)(t.p,{children:"See the following topics for more information:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/docs/latest/ingestion/rollup",children:"Data rollup"})," for suggestions and best practices when performing rollup."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/docs/latest/multi-stage-query/concepts#rollup",children:"SQL-based ingestion concepts"})," for information on rollup using SQL-based ingestion."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/docs/latest/multi-stage-query/examples#insert-with-rollup",children:"SQL-based ingestion query examples"})," for another example of data rollup."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.a,{href:"/docs/latest/ingestion/schema-model",children:"Druid schema model"})," to learn about the primary timestamp, dimensions, and metrics."]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,d.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},28453:(e,t,s)=>{s.d(t,{R:()=>i,x:()=>c});var n=s(96540);const r={},d=n.createContext(r);function i(e){const t=n.useContext(d);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),n.createElement(d.Provider,{value:t},e.children)}}}]);