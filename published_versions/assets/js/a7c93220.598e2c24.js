"use strict";(self.webpackChunk=self.webpackChunk||[]).push([[7806],{8406:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-07-e6e0a2617410595ee7ce54d48ea43e7b.png"},15437:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-04-36f7ed804ee7538d35d6fe31da6fbfae.png"},26430:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"tutorials/tutorial-compaction","title":"Compact segments","description":"\x3c!--","source":"@site/docs/33.0.0/tutorials/tutorial-compaction.md","sourceDirName":"tutorials","slug":"/tutorials/tutorial-compaction","permalink":"/docs/33.0.0/tutorials/tutorial-compaction","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"tutorial-compaction","title":"Compact segments","sidebar_label":"Compact segments"},"sidebar":"docs","previous":{"title":"Update data","permalink":"/docs/33.0.0/tutorials/tutorial-update-data"},"next":{"title":"Deleting data","permalink":"/docs/33.0.0/tutorials/tutorial-delete-data"}}');var s=n(74848),i=n(28453);const o={id:"tutorial-compaction",title:"Compact segments",sidebar_label:"Compact segments"},r=void 0,c={},l=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Load the initial data",id:"load-the-initial-data",level:2},{value:"Compact the data",id:"compact-the-data",level:2},{value:"Compact the data with new segment granularity",id:"compact-the-data-with-new-segment-granularity",level:2},{value:"Learn more",id:"learn-more",level:2}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"This tutorial demonstrates how to compact existing segments into fewer but larger segments in Apache Druid."}),"\n",(0,s.jsxs)(t.p,{children:["There is some per-segment memory and processing overhead during query processing.\nTherefore, it can be beneficial to reduce the total number of segments.\nSee ",(0,s.jsx)(t.a,{href:"/docs/33.0.0/operations/segment-optimization",children:"Segment size optimization"})," for details."]}),"\n",(0,s.jsx)(t.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(t.p,{children:["This tutorial assumes you have already downloaded Apache Druid as described in\nthe ",(0,s.jsx)(t.a,{href:"/docs/33.0.0/tutorials/",children:"single-machine quickstart"})," and have it running on your local machine."]}),"\n",(0,s.jsx)(t.p,{children:"If you haven't already, you should finish the following tutorials first:"}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/docs/33.0.0/tutorials/tutorial-batch",children:"Tutorial: Loading a file"})}),"\n",(0,s.jsx)(t.li,{children:(0,s.jsx)(t.a,{href:"/docs/33.0.0/tutorials/tutorial-query",children:"Tutorial: Querying data"})}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"load-the-initial-data",children:"Load the initial data"}),"\n",(0,s.jsxs)(t.p,{children:["This tutorial uses the Wikipedia edits sample data included with the Druid distribution.\nTo load the initial data, you use an ingestion spec that loads batch data with segment granularity of ",(0,s.jsx)(t.code,{children:"HOUR"})," and creates between one and three segments per hour."]}),"\n",(0,s.jsxs)(t.p,{children:["You can review the ingestion spec at ",(0,s.jsx)(t.code,{children:"quickstart/tutorial/compaction-init-index.json"}),".\nSubmit the spec as follows to create a datasource called ",(0,s.jsx)(t.code,{children:"compaction-tutorial"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"bin/post-index-task --file quickstart/tutorial/compaction-init-index.json --url http://localhost:8081\n"})}),"\n",(0,s.jsx)(t.admonition,{type:"info",children:(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"maxRowsPerSegment"})," in the tutorial ingestion spec is set to 1000 to generate multiple segments per hour for demonstration purposes. Do not use this spec in production."]})}),"\n",(0,s.jsxs)(t.p,{children:["After the ingestion completes, navigate to ",(0,s.jsx)(t.a,{href:"http://localhost:8888/unified-console.html#datasources",children:"http://localhost:8888/unified-console.html#datasources"})," in a browser to see the new datasource in the web console."]}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"compaction-tutorial datasource",src:n(27840).A+"",title:"compaction-tutorial datasource",width:"1274",height:"228"})}),"\n",(0,s.jsxs)(t.p,{children:["In the ",(0,s.jsx)(t.strong,{children:"Availability"})," column for the ",(0,s.jsx)(t.code,{children:"compaction-tutorial"})," datasource, click the link for ",(0,s.jsx)(t.strong,{children:"51 segments"})," to view segments information for the datasource."]}),"\n",(0,s.jsx)(t.p,{children:"The datasource comprises 51 segments, between one and three segments per hour from the input data:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Original segments",src:n(82875).A+"",title:"Original segments",width:"1275",height:"772"})}),"\n",(0,s.jsx)(t.p,{children:"Run a COUNT query on the datasource to verify there are 39,244 rows:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'dsql> select count(*) from "compaction-tutorial";\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 EXPR$0 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  39244 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nRetrieved 1 row in 1.38s.\n'})}),"\n",(0,s.jsx)(t.h2,{id:"compact-the-data",children:"Compact the data"}),"\n",(0,s.jsxs)(t.p,{children:["Now you compact these 51 small segments and retain the segment granularity of ",(0,s.jsx)(t.code,{children:"HOUR"}),".\nThe Druid distribution includes a compaction task spec for this tutorial datasource at ",(0,s.jsx)(t.code,{children:"quickstart/tutorial/compaction-keep-granularity.json"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "type": "compact",\n  "dataSource": "compaction-tutorial",\n  "interval": "2015-09-12/2015-09-13",\n  "tuningConfig" : {\n    "type" : "index_parallel",\n    "partitionsSpec": {\n        "type": "dynamic"\n    },\n    "maxRowsInMemory" : 25000\n  }\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["This compacts all segments for the interval ",(0,s.jsx)(t.code,{children:"2015-09-12/2015-09-13"})," in the ",(0,s.jsx)(t.code,{children:"compaction-tutorial"})," datasource."]}),"\n",(0,s.jsxs)(t.p,{children:["The parameters in the ",(0,s.jsx)(t.code,{children:"tuningConfig"})," control the maximum number of rows present in each compacted segment and thus affect the number of segments in the compacted set."]}),"\n",(0,s.jsxs)(t.p,{children:["This datasource only has 39,244 rows. 39,244 is below the default limit of 5,000,000 ",(0,s.jsx)(t.code,{children:"maxRowsPerSegment"})," for ",(0,s.jsx)(t.a,{href:"/docs/33.0.0/ingestion/native-batch#dynamic-partitioning",children:"dynamic partitioning"}),". Therefore, Druid only creates one compacted segment per hour."]}),"\n",(0,s.jsx)(t.p,{children:"Submit the compaction task now:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"bin/post-index-task --file quickstart/tutorial/compaction-keep-granularity.json --url http://localhost:8081\n"})}),"\n",(0,s.jsxs)(t.p,{children:["After the task finishes, refresh the ",(0,s.jsx)(t.a,{href:"http://localhost:8888/unified-console.html#segments",children:"segments view"}),"."]}),"\n",(0,s.jsx)(t.p,{children:"Over time the Coordinator marks the original 51 segments as unused and subsequently removes them to leave only the new compacted segments."}),"\n",(0,s.jsx)(t.p,{children:"By default, the Coordinator does not mark segments as unused until the Coordinator has been running for at least 15 minutes.\nDuring that time, you may see 75 total segments comprised of the old segment set and the new compacted set:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Compacted segments intermediate state 1",src:n(33874).A+"",title:"Compacted segments intermediate state 1",width:"1334",height:"175"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Compacted segments intermediate state 2",src:n(15437).A+"",title:"Compacted segments intermediate state 2",width:"1334",height:"792"})}),"\n",(0,s.jsx)(t.p,{children:"The new compacted segments have a more recent version than the original segments.\nEven though the web console displays both sets of segments, queries only read from the new compacted segments."}),"\n",(0,s.jsxs)(t.p,{children:["Run a COUNT query on ",(0,s.jsx)(t.code,{children:"compaction-tutorial"})," again to verify the number of rows remains 39,244:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:'dsql> select count(*) from "compaction-tutorial";\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 EXPR$0 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  39244 \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\nRetrieved 1 row in 1.30s.\n'})}),"\n",(0,s.jsx)(t.p,{children:"After the Coordinator has been running for at least 15 minutes, the segments view only shows the new 24 segments, one for each hour:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Compacted segments hourly granularity 1",src:n(72932).A+"",title:"Compacted segments hourly granularity 1",width:"1330",height:"164"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Compacted segments hourly granularity 2",src:n(86495).A+"",title:"Compacted segments hourly granularity 2",width:"1330",height:"896"})}),"\n",(0,s.jsx)(t.h2,{id:"compact-the-data-with-new-segment-granularity",children:"Compact the data with new segment granularity"}),"\n",(0,s.jsx)(t.p,{children:"You can also change the segment granularity in a compaction task to produce compacted segments with a different granularity from that of the input segments."}),"\n",(0,s.jsxs)(t.p,{children:["The Druid distribution includes a compaction task spec to create ",(0,s.jsx)(t.code,{children:"DAY"})," granularity segments at ",(0,s.jsx)(t.code,{children:"quickstart/tutorial/compaction-day-granularity.json"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-json",children:'{\n  "type": "compact",\n  "dataSource": "compaction-tutorial",\n  "interval": "2015-09-12/2015-09-13",\n  "tuningConfig" : {\n    "type" : "index_parallel",\n    "partitionsSpec": {\n        "type": "dynamic"\n    },\n    "maxRowsInMemory" : 25000,\n    "forceExtendableShardSpecs" : true\n  },\n  "granularitySpec" : {\n    "segmentGranularity" : "DAY",\n    "queryGranularity" : "none"\n  }\n}\n'})}),"\n",(0,s.jsxs)(t.p,{children:["Note that ",(0,s.jsx)(t.code,{children:"segmentGranularity"})," is set to ",(0,s.jsx)(t.code,{children:"DAY"})," in this compaction task spec."]}),"\n",(0,s.jsx)(t.p,{children:"Submit this task now:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-bash",children:"bin/post-index-task --file quickstart/tutorial/compaction-day-granularity.json --url http://localhost:8081\n"})}),"\n",(0,s.jsx)(t.p,{children:"It takes some time before the Coordinator marks the old input segments as unused, so you may see an intermediate state with 25 total segments. Eventually, only one DAY granularity segment remains:"}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Compacted segments day granularity 1",src:n(8406).A+"",title:"Compacted segments day granularity 1",width:"1331",height:"181"})}),"\n",(0,s.jsx)(t.p,{children:(0,s.jsx)(t.img,{alt:"Compacted segments day granularity 2",src:n(36241).A+"",title:"Compacted segments day granularity 2",width:"1334",height:"171"})}),"\n",(0,s.jsx)(t.h2,{id:"learn-more",children:"Learn more"}),"\n",(0,s.jsx)(t.p,{children:"This tutorial demonstrated how to use a compaction task spec to manually compact segments and how to optionally change the segment granularity for segments."}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["For more details, see ",(0,s.jsx)(t.a,{href:"/docs/33.0.0/data-management/compaction",children:"Compaction"}),"."]}),"\n",(0,s.jsxs)(t.li,{children:["To learn about the benefits of compaction, see ",(0,s.jsx)(t.a,{href:"/docs/33.0.0/operations/segment-optimization",children:"Segment optimization"}),"."]}),"\n"]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},27840:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-01-122ba6887d51536c0799f2b4f105f00c.png"},28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>r});var a=n(96540);const s={},i=a.createContext(s);function o(e){const t=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),a.createElement(i.Provider,{value:t},e.children)}},33874:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-03-7fdb3f2fed5120f81ff7fa1b0659b1da.png"},36241:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-08-c185270edb96314c1d83efeb308b4bf3.png"},72932:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-05-c6b86c4a1c1aeeccad0e4567f43f7112.png"},82875:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-02-3e62bb856c0c0cf0b318520c7d071bb5.png"},86495:(e,t,n)=>{n.d(t,{A:()=>a});const a=n.p+"assets/images/tutorial-compaction-06-d55426f79668b103a03066b3fb602d1b.png"}}]);